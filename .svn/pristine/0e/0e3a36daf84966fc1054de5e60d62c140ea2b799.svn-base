/** 
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 3. 26.     	JSW            ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */
document.addEventListener("DOMContentLoaded", () => {
       // FancyTree ì´ˆê¸°í™”
       $("#depTree").fancytree({
           source: {
               url: contextPath + "/" + companyNo + "/organization/admin/parentDep",
               cache: false
           },
           lazyLoad: function(event, data) {
               var node = data.node;
               let mode = "employee";
               if (!node.data.parentDeptCd) {
                   mode = "department";
               }
               // Load child nodes via Ajax
               data.result = {
                   url: contextPath + "/" + companyNo + "/organization/admin/childeDep",
                   data: {mode: mode, parent: node.key},
                   cache: false
               };
           },
           renderNode: function(event, data) {
               var node = data.node;
               var $span = $(node.span);
			   
			   // ê¸°ì¡´ ì•„ì´ì½˜ ì œê±° (ì¤‘ë³µ ë°©ì§€)
			   $span.find(".fancytree-icon").remove();
               if (node.data.empNm) {
                   // ì‚¬ì› ë…¸ë“œ
				   const isManager = node.parent && node.parent.data.managerEmpId === node.data.empId;

		           const iconClass = isManager ? "fas fa-user-tie" : "fas fa-user";
		           const iconHtml = `<i class="${iconClass} fancytree-icon"></i>`;

		           $span.find(".fancytree-title").html(
		               `${iconHtml} ${node.data.empNm} (${node.data.positionName})`
		           );
			   } else {
                  // ë¶€ì„œ ë…¸ë“œ
                  $span.find(".fancytree-title").prepend(
                      `<i class="fas fa-building fancytree-icon"></i> `
                  );  
               }
           },
           activate: function(event, data) {
               var node = data.node;
               if (node.data.empNm) {
                   // ì‚¬ì› ì •ë³´ í‘œì‹œ
                   showEmployeeDetail(node.data);
               } else {
                   // ë¶€ì„œ ì •ë³´ í‘œì‹œ
                   showDepartmentDetail(node.data);
               }
           }
       });
	    
       function showEmployeeDetail(employee) {
           let detailHtml = `
               <div class="employee-detail">
                   <h3>${employee.empNm} ${employee.positionName}</h3>
                   <p><strong>ì‚¬ì›ë²ˆí˜¸ : </strong> ${employee.empNo}</p>
                   <p><strong>ì´ë©”ì¼ : </strong> ${employee.empEmail || '-'}</p>
                   <p><strong>ì „í™”ë²ˆí˜¸ : </strong> ${employee.empPhone || '-'}</p>
                   <p><strong>ì…ì‚¬ì¼ : </strong> ${employee.empRegdate || '-'}</p>
               </div>
           `;
           $("#detailContent").html(detailHtml);
       }
       
       function showDepartmentDetail(department) {
           let detailHtml = `
		   <h4 class="mb-3">${department.deptName}</h4>
		   <div class="department-detail">
               <p>
                   <strong>ë¶€ì„œëª… : </strong>
                   <span id="deptNameText">${department.deptName}</span>
                   <img src="${contextPath}/resources/groupware/images/edit.png" class="edit-icon" data-field="deptName">
               </p>
               <p>
                   <strong>ë¶€ì„œì½”ë“œ : </strong>
                   <span id="deptCdText">${department.deptCd}</span>
               </p>
               <p>
                   <strong>ë¶€ì„œì¥ ID : </strong>
                   <span id="managerEmpIdText">${department.managerEmpId || '-'}</span>
                   <img src="${contextPath}/resources/groupware/images/edit.png" class="edit-icon" data-field="managerEmpId">
               </p>
           </div>
           `;
		   
		   //í•˜ìœ„ ë¶€ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
	      $.ajax({
	          type: "GET",
	          url: `${contextPath}/${companyNo}/organization/admin/childDepartments`,
	          data: { parentDeptCd: department.deptCd },
	          success: function (children) {
	              if (children.length > 0) {
	                  detailHtml += `
				  		<div class="sub-dept-wrapper">
					        <span class="sub-dept-label"><strong>í•˜ìœ„ ë¶€ì„œ : </strong></span>
					        <ul class="sub-dept-list">
						`;
	                  children.forEach(dept => {
	                      detailHtml += `<li class="dept-badge">${dept.deptName}</li>`;
	                  });
	                  detailHtml += `</ul>`;
	              } else {
	                  detailHtml += `<p><strong>í•˜ìœ„ ë¶€ì„œ :</strong> ë¯¸ì§€ì •</p>`;
	              }

	              detailHtml += `</div>`;
	              $("#detailContent").html(detailHtml);
	          },
	          error: function () {
	              detailHtml += `<p><strong>í•˜ìœ„ ë¶€ì„œ : </strong> ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p></div>`;
	              $("#detailContent").html(detailHtml);
	          }
	      });
       }
	   $(document).on("click", ".edit-icon", function () {
	       const field = $(this).data("field");
	       const span = $(`#${field}Text`);
	       const currentValue = span.text().trim();

		   if (field === "managerEmpId") {
		           // ë¶€ì„œì¥ ìˆ˜ì •ì¼ ê²½ìš° selectë¡œ ì²˜ë¦¬
		           $.ajax({
		               type: "GET",
		               url: `${contextPath}/${companyNo}/organization/admin/employees`,
		               success: function (employees) {
		                   const select = $('<select id="managerEmpIdInput"></select>');
		                   select.append(`<option value="">ì„ íƒí•˜ì„¸ìš”</option>`);

		                   employees.forEach(emp => {
		                       const optionText = `${emp.empNm} (${emp.empId})`;
		                       const selected = emp.empId === currentValue ? "selected" : "";
		                       select.append(`<option value="${emp.empId}" ${selected}>${optionText}</option>`);
		                   });

		                   span.replaceWith(select);
		                   select.focus();

		                   // ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥
		                   select.on("change", function () {
		                       const newValue = $(this).val();
		                       updateDepartmentField("managerEmpId", newValue);
		                   });

		                   // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì €ì¥
		                   select.on("blur", function () {
		                       const newValue = $(this).val();
		                       updateDepartmentField("managerEmpId", newValue);
		                   });
		               }
		           });

		       } else {
		           // ì¼ë°˜ í…ìŠ¤íŠ¸ í•„ë“œëŠ” input ì²˜ë¦¬
		           const input = $(`<input type="text" id="${field}Input" value="${currentValue}"/>`);
		           span.replaceWith(input);
		           input.focus();

		           input.on("keyup", function (e) {
		               if (e.key === "Enter") {
		                   const newValue = input.val().trim();
		                   updateDepartmentField(field, newValue);
		               }
		           });

		           input.on("blur", function () {
		               const newValue = input.val().trim();
		               updateDepartmentField(field, newValue);
		           });
		       }
		   });
	   function updateDepartmentField(field, newValue) {
	       const deptCd = $("#deptCdText").text().trim();

	       const payload = {
	           deptCd: deptCd,
	           companyNo: companyNo,
	       };
	       payload[field] = newValue;

	       $.ajax({
	           type: "PATCH",
	           url: `${contextPath}/${companyNo}/department/updateField`,
	           contentType: "application/json",
	           data: JSON.stringify(payload),
	           success: function () {
	               Swal.fire({
					   toast: true,
					   position: 'top',
	                   icon: "success",
	                   title: "ìˆ˜ì • ì™„ë£Œ",
	                   text: "ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.",
					   showConfirmButton: false,
					   timer: 2000
	               });

				   // âœ… ì¡°ì§ë„ íŠ¸ë¦¬ ìƒˆë¡œê³ ì¹¨!
		              $("#depTree").fancytree("getTree").reload({
		                  url: `${contextPath}/${companyNo}/organization/admin/parentDep`,
		                  cache: false
		              });

		              // âœ… ìƒì„¸ë³´ê¸° ì´ˆê¸°í™” (ì„ íƒí•´ì œ)
		              $("#detailContent").html(`<p>ë¶€ì„œ ë˜ëŠ” ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>`);
		          },
	           error: function () {
	               Swal.fire({
					   toast: true,
					   position: 'top',
	                   icon: "error",
	                   title: "ìˆ˜ì • ì‹¤íŒ¨",
	                   text: "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
					   showConfirmButton: false,
   					   timer: 2000
	               });
	           }
	       });
	   }
	   $("#search-btn").on("click", function() {
	       var keyword = $("#employee-search").val().trim(); // ê³µë°± ì œê±°
	       
	       if (!keyword) {
				Swal.fire({
					toast: true,
				   	position: 'top',
				    icon: 'warning',
				    title: 'ê²€ìƒ‰ì–´ ëˆ„ë½',
				    text: 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
				    confirmButtonColor: '#3085d6',
					showConfirmButton: false,
				   	timer: 2000	
				});
	           return;
	       }
	       
	       // AJAX ê²€ìƒ‰ ìš”ì²­
	       $.ajax({
	           url: contextPath + "/" + companyNo + "/organization/admin/search",
	           type: "GET",
	           data: { keyword },
	           success: function(data) {
	               // ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
	               renderTree(data);
	           },
	           error: function(xhr) {
				Swal.fire({
					toast: true,
				   	position: 'top',
				    icon: 'error',
				    title: 'ê²€ìƒ‰ ì‹¤íŒ¨',
				    html: `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`,
				    confirmButtonColor: '#d33',
					showConfirmButton: false,
				  	timer: 2000	
				});
	           }
	       });
	   });
	   $("#employee-search").on("keyup", function(e) {
		const keyword = $(this).val().trim();
			
			if (e.key === "Enter") {
	           $("#search-btn").click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì‹¤í–‰
	       }
		   if (keyword === "") {
             // ì „ì²´ íŠ¸ë¦¬ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
             $("#depTree").fancytree("getTree").reload({
                 url: `${contextPath}/${companyNo}/organization/admin/parentDep`,
                 cache: false
             });
		  }
	   });
	   // ë¶€ì„œ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
	      $('#add-dept-btn').on('click', function () {
			$('#companyNo').val(companyNo);  
			$('#addDeptModal').fadeIn();
	      });

	      // ëª¨ë‹¬ ë‹«ê¸°
	      $('#cancelAddDept, .close-modal').on('click', function () {
	          $('#addDeptModal').fadeOut();
	      });

	      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
	      $(window).on('click', function (e) {
	          if ($(e.target).is('#addDeptModal')) {
	              $('#addDeptModal').fadeOut();
	          }
	      });
		  
		  function loadEmployeeListForManager() {
		      $.ajax({
		          type: "GET",
		          url: `${contextPath}/${companyNo}/organization/admin/employees`, // ğŸ”¥ ì‚¬ì› ëª©ë¡ ì¡°íšŒìš© URL
		          success: function (employees) {
		              const $select = $("#managerEmpId");
		              $select.empty().append(`<option value="">ì„ íƒí•˜ì„¸ìš”</option>`);
		              employees.forEach(emp => {
		                  const optionText = `${emp.empNm} (${emp.empId})`;
		                  $select.append(`<option value="${emp.empId}">${optionText}</option>`);
		              });
		          },
		          error: function () {
		              Swal.fire({
						  toast: true,
					   	  position: 'top',
		                  icon: 'error',
		                  title: 'ì‚¬ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨',
		                  text: 'ë¶€ì„œì¥ ì„ íƒì„ ìœ„í•´ ì‚¬ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
						  showConfirmButton: false,
	  				  	  timer: 2000		
		              });
		          }
		      });
		  }
		  
		  // ëª¨ë‹¬ ì—´ ë•Œ ì‚¬ì› ëª©ë¡ë„ ë¶ˆëŸ¬ì˜¤ê¸°
		  $('#add-dept-btn, #editDeptBtn').on('click', function () {
		      $('#addDeptModal').fadeIn();
		      loadEmployeeListForManager(); // ğŸ”¥ ì‚¬ì› ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
		  });

	      // ë¶€ì„œ ì¶”ê°€ í¼ submit
		  $('#addDeptForm').on('submit', function (e) {
		      e.preventDefault();

		      const deptData = {
				  deptCd: $('#deptCd').val(),
		          deptName: $('#deptName').val(),
		          parentDeptCd: $('#parentDeptCd').val(),
		          managerEmpId: $('#managerEmpId').val(),
		          companyNo: companyNo
		      };

		      $.ajax({
		          type: 'POST',
		          url: `${contextPath}/${companyNo}/department/new/dept`,
		          contentType: 'application/json',
		          data: JSON.stringify(deptData),
		          success: function (result) {
		              // âœ… ì„±ê³µ ì‹œ: ëª¨ë‹¬ ë‹«ê³  -> Swal ë„ìš°ê¸°
		              $('#addDeptModal').fadeOut(200, function () {
		                  Swal.fire({
							  toast: true,
						   	  position: 'top',
		                      icon: 'success',
		                      title: 'ë“±ë¡ ì™„ë£Œ',
		                      text: 'ë¶€ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
		                      confirmButtonColor: '#3085d6',
							  showConfirmButton: false,
	  	  				  	  timer: 2000
		                  });

		                  // íŠ¸ë¦¬ ìƒˆë¡œê³ ì¹¨
		                  $("#depTree").fancytree("getTree").reload({
		                      url: `${contextPath}/${companyNo}/organization/admin/parentDep`,
		                      cache: false
		                  });
		              });
		          },
		          error: function () {
		              // âŒ ì‹¤íŒ¨ ì‹œ: ëª¨ë‹¬ì€ ìœ ì§€, Swalë§Œ ë„ìš°ê¸° (ì•ì— ë„ìš°ëŠ” ê±°ë¼ z-index ë¬¸ì œ ì—†ìŒ)
		              Swal.fire({
						  toast: true,
					   	  position: 'top',
		                  icon: 'error',
		                  title: 'ë“±ë¡ ì‹¤íŒ¨',
		                  text: 'ë¶€ì„œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
		                  confirmButtonColor: '#d33',
						  showConfirmButton: false,
  	  				  	  timer: 2000
		              });
		          }
		      });
		  });
	  $("#delete-dept-btn").on("click", function () {
	      const tree = $("#depTree").fancytree("getTree");
	      const node = tree.getActiveNode();

	      // ì„ íƒëœ ë…¸ë“œê°€ ì—†ê±°ë‚˜, ì‚¬ì› ë…¸ë“œì¸ ê²½ìš°
	      if (!node || node.data.empNm) {
	          Swal.fire({
				  toast: true,
			   	  position: 'top',
	              icon: 'warning',
	              title: 'ì‚­ì œí•  ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.',
	              text: 'ì‚¬ì›ì´ ì•„ë‹Œ ë¶€ì„œë¥¼ ì„ íƒí•´ì•¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
	              confirmButtonColor: '#3085d6',
				  showConfirmButton: false,
			  	  timer: 2000
	          });
	          return;
	      }

	      const deptCd = node.key;
	      const deptName = node.title;

	      Swal.fire({
	          title: `"${deptName}" ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
	          text: "í•˜ìœ„ ë¶€ì„œë‚˜ ì‚¬ì›ì´ ìˆìœ¼ë©´ ì‚­ì œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
	          icon: 'warning',
	          showCancelButton: true,
	          confirmButtonColor: '#d33',
	          cancelButtonColor: '#3085d6',
	          confirmButtonText: 'ì‚­ì œ',
	          cancelButtonText: 'ì·¨ì†Œ'
	      }).then((result) => {
	          if (result.isConfirmed) {
	              $.ajax({
	                  type: "DELETE",
	                  url: `${contextPath}/${companyNo}/department/delete/${deptCd}`,
	                  success: function () {
	                      Swal.fire({
							  toast: true,
							  position: 'top',
	                          icon: 'success',
	                          title: 'ì‚­ì œ ì™„ë£Œ',
	                          text: `"${deptName}" ë¶€ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`,
							  showConfirmButton: false,
    	  				  	  timer: 2000
	                      });

	                      // íŠ¸ë¦¬ ë¦¬ë¡œë“œ
	                      tree.reload({
	                          url: `${contextPath}/${companyNo}/organization/admin/parentDep`,
	                          cache: false
	                      });

	                      // ìƒì„¸ ì´ˆê¸°í™”
	                      $("#detailContent").html(`<p>ë¶€ì„œ ë˜ëŠ” ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>`);
	                  },
	                  error: function () {
	                      Swal.fire({
							  toast: true,
							  position: 'top',
	                          icon: 'error',
	                          title: 'ì‚­ì œ ì‹¤íŒ¨',
	                          text: `"${deptName}" ë¶€ì„œë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
							  showConfirmButton: false,
      	  				  	  timer: 2000
	                      });
	                  }
	              });
	          }
	      });
	  }); 
	  
	  $(document).on("click", "#bulkInsertBtn", function (e) {
	      e.preventDefault(); // ê¸°ë³¸ ì´ë™ ë§‰ê¸°

	      const targetUrl = $(this).attr("href");

	      Swal.fire({
	          title: 'ì¼ê´„ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
	          text: "ì§„í–‰ ì¤‘ì¸ ì •ë³´ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
	          icon: 'question',
	          showCancelButton: true,
	          confirmButtonColor: '#2c7be5',
	          cancelButtonColor: '#d33',
	          confirmButtonText: 'í™•ì¸',
	          cancelButtonText: 'ì·¨ì†Œ'
	      }).then((result) => {
	          if (result.isConfirmed) {
	              location.href = targetUrl;
	          }
	      });
	  });
	
});
function renderTree(data) {
    $("#depTree").fancytree("getTree").reload(data);
  };