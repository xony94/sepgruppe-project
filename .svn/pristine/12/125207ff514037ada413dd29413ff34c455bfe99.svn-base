package kr.or.ddit.works.organization.controller;

import java.io.IOException;
import java.net.URLEncoder;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.lang3.StringUtils;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import kr.or.ddit.paging.PaginationInfo;
import kr.or.ddit.paging.PaginationRenderer;
import kr.or.ddit.paging.SimpleCondition;
import kr.or.ddit.works.organization.service.EmployeeService;
import kr.or.ddit.works.organization.vo.DepartmentVO;
import kr.or.ddit.works.organization.vo.EmployeeVO;
import kr.or.ddit.works.organization.vo.OrganizationVO;
import lombok.extern.slf4j.Slf4j;

/**
 * ì¸ì‚¬ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
 *
 * @author JYS
 * @since 2025. 3. 13.
 * @see
 *
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 13.     	JYS	          ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */
@Slf4j
@Controller
@RequestMapping("/{companyNo}/employee")
public class EmployeeController {

	@Autowired
	private EmployeeService service;
	
	@Autowired
	private PaginationRenderer paginationRenderer;

    /** ê´€ë¦¬ì - ì „ì‚¬ ì¸ì‚¬ì •ë³´ ì¡°íšŒ */
    /** ê¶Œí•œì„ ë¶€ì—¬ë°›ì€ ì - ê° ë¶€ì„œ ì‚¬ì› ì¸ì‚¬ì •ë³´ ì¡°íšŒ */
    @GetMapping("/admin/list")
    public String selectListAllEmployee(
    	@PathVariable("companyNo") String companyNo
    	, @RequestParam(defaultValue = "1") int page
    	, @ModelAttribute SimpleCondition simpleCondition
    	, Model model
    ) {
    	PaginationInfo<OrganizationVO> paging = new PaginationInfo<>(10, 2); 
        paging.setCurrentPage(page);
        paging.setSimpleCondition(simpleCondition);

        PaginationInfo<OrganizationVO> pageData = service.getAllEmployees(companyNo, paging); 

        model.addAttribute("pageData", pageData);
        model.addAttribute("simpleCondition", simpleCondition);

        return "gw:admin/employee/employeeList";
    }

    /** ê´€ë¦¬ì - ìƒì„¸ ì¸ì‚¬ì •ë³´ ì¡°íšŒ */
    /** ê¶Œí•œì„ ë¶€ì—¬ë°›ì€ ì - ê° ë¶€ì„œ ì‚¬ì› ì¸ì‚¬ì •ë³´ ì¡°íšŒ */
    @GetMapping("/{empNo}")
    public String selectEmployee(@PathVariable("companyNo") String companyNo, @PathVariable("empNo") String empNo) {
        return "gw:employee/employeeDetail";
    }
    
    @GetMapping("/departments")
    @ResponseBody
    public List<DepartmentVO> getDepartments(@PathVariable("companyNo") String companyNo) {
        return service.selectDepartments(companyNo);
    }

    /** ê´€ë¦¬ì - ì¸ì‚¬ ì •ë³´ ë“±ë¡ í¼ */
//    @GetMapping("/new")
//    public String insertEmployeeFormUI(@PathVariable("companyNo") String companyNo) {
//        return "gw:admin/employee/employeeForm";
//    }

    /** ê´€ë¦¬ì - ì¸ì‚¬ ì •ë³´ ë“±ë¡ */
    @PostMapping("/new")
    @ResponseBody
    public ResponseEntity<?> insertEmployee(
        @PathVariable("companyNo") String companyNo,
        @ModelAttribute EmployeeVO member
    ) {
        member.setCompanyNo(companyNo);
        int result = service.insertEmployee(member);

        return result > 0 ? ResponseEntity.ok().build()
                          : ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
    }

    /** ê´€ë¦¬ì - ì¸ì‚¬ ì •ë³´ ìˆ˜ì • í¼ */
    @GetMapping("/{empNo}/edit")
    public String updateEmployeeFormUI(@PathVariable("companyNo") String companyNo, @PathVariable("empNo") String empNo) {
        return "gw:employee/employeeEdit";
    }

    /** ê´€ë¦¬ì - ì¸ì‚¬ ì •ë³´ ìˆ˜ì • */
    @PutMapping("/{empNo}/edit")
    public String updateEmployee(@PathVariable("companyNo") String companyNo, @PathVariable("empNo") String empNo) {
        return "redirect:/" + companyNo + "/employee/" + empNo;
    }

    /** ê´€ë¦¬ì - ì¸ì‚¬ ì •ë³´ ì‚­ì œ(í‡´ì‚¬ ì²˜ë¦¬) (ë¹„í™œì„±í™”) */
    @PutMapping("/{empNo}/deactivate")
    public String deactivateEmployee(@PathVariable("companyNo") String companyNo, @PathVariable("empNo") String empNo) {
        // ì‚­ì œ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ (ë¹„í™œì„±í™” ì²˜ë¦¬)
        return "redirect:/" + companyNo + "/employee";
    }

    /** ê´€ë¦¬ì - ì¸ì‚¬ ê´€ë¦¬ ê¶Œí•œ ì„¤ì • */

    /** ì‚¬ì› - ë‚´ ì¸ì‚¬ ì •ë³´ ì¡°íšŒ */
    @GetMapping("/myEmployee")
    public String selectMyEmployee(
    		@PathVariable("companyNo") String companyNo
    		, Authentication authentication
        	, Model model
    ) {
    	EmployeeVO member = service.selectEmployee(authentication.getName());
    	model.addAttribute("member", member);
    	return "gw:employee/myEmployee";
    }

    /** ì‚¬ì› ë§ˆì´í˜ì´ì§€ */
    @GetMapping("/mypage")
    public String selectMyPage(
    	@PathVariable("companyNo") String companyNo
    	, Authentication authentication
    	, Model model
    	) {

			EmployeeVO member = service.selectEmployee(authentication.getName()); // ì¶”ê°€í•¨
			model.addAttribute("member", member);
    	return "gw:employee/myPage";
    }

	/** ì‚¬ì› ë§ˆì´í˜ì´ì§€ ì •ë³´ ìˆ˜ì • */
	@PostMapping("/mypage/edit")
	public String updateEmployee(
			Authentication authentication
			, @PathVariable("companyNo") String companyNo
			, @ModelAttribute("member") EmployeeVO member
			, HttpSession session
		) {
		member.setEmpId(authentication.getName());


			service.updateEmployee(member);

			session.setAttribute("authMember", service.selectEmployee(member.getEmpId()));


		return "redirect:/{companyNo}/employee/mypage";
	}

	/** ì‚¬ì› ë§ˆì´í˜ì´ì§€ í”„ë¡œí•„ ì‚¬ì§„ ì‚­ì œ */
	@PostMapping("/deleteImg")
	public void deleteImage(@RequestParam("empId") String empId) {
		log.info("ì´ë¯¸ì§€ì‚­ì œ ì‹¤í–‰ ==================");
		service.deleteImage(empId);
	}

	@PostMapping("/mypage/verifyPassword")
	public ResponseEntity<Object> verifyPassword(
			Authentication authentication
			, @RequestBody EmployeeVO emp
		) {
		System.out.println("======================= ê²€ì¦ì¤‘ =======================");
	    String empId = authentication.getName();

	    boolean checkPw = service.authenticateMember(empId, emp.getEmpPw()); // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ í˜¸ì¶œ

	        // ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ë¡œì§ í˜¸ì¶œ
	    if(checkPw)
	        return ResponseEntity.ok().build(); // ì¸ì¦ ì„±ê³µ
	    else
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build(); // ì¸ì¦ ì‹¤íŒ¨
	}
	
	@PutMapping("/admin/bulkUpdate")
	@ResponseBody
	public ResponseEntity<?> bulkUpdate(
			@PathVariable("companyNo") String companyNo,
			@RequestBody Map<String, Object> payload
	) {
		 List<String> empIds = (List<String>) payload.get("empIds");
		    String fieldType = (String) payload.get("fieldType"); // "position" or "department"
		    String value = (String) payload.get("value");

		    int updatedCount = service.bulkUpdateEmployees(empIds, fieldType, value);

		    return updatedCount > 0 ? ResponseEntity.ok().build()
                    : ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
	}
	
	@DeleteMapping("/admin/delete")
	@ResponseBody
	public ResponseEntity<?> deleteEmployees(
	    @PathVariable("companyNo") String companyNo,
	    @RequestBody List<String> empIds
	) {
	    int deletedCount = service.deleteEmployees(empIds, companyNo);
	    return deletedCount > 0
	        ? ResponseEntity.ok().build()
	        : ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
	}
	
	@GetMapping("/admin/ajaxList")
	@ResponseBody
	public Map<String, Object> getAjaxEmployeeList(
	    @PathVariable("companyNo") String companyNo,
	    @RequestParam Map<String, String> param
	) {
	    int start = Integer.parseInt(param.get("start")); // ì‹œì‘ ì¸ë±ìŠ¤
	    int length = Integer.parseInt(param.get("length")); // í˜ì´ì§€ í¬ê¸°
	    int page = (start / length) + 1;

	    String searchType = param.get("searchType");
	    String searchWord = param.get("searchWord");
	    
	    log.info("ğŸ¯ searchType: {}", searchType);  // ì´ê±° nullì´ë©´ ë¬¸ì œ
	    log.info("ğŸ¯ searchWord: {}", searchWord);

	    SimpleCondition condition = new SimpleCondition();
	    condition.setSearchType(searchType);
	    condition.setSearchWord(searchWord);

	    PaginationInfo<OrganizationVO> paging = new PaginationInfo<>(length, 2);
	    paging.setCurrentPage(page);
	    paging.setSimpleCondition(condition);
	    
	    paging = service.getAllEmployees(companyNo, paging);
	    
	    Map<String, Object> result = new HashMap<>();
	    result.put("draw", Integer.parseInt(param.get("draw")));
	    result.put("recordsTotal", paging.getTotalRecord());        
	    result.put("recordsFiltered", paging.getTotalRecord());     
	    result.put("data", paging.getDataList());
	    return result;
	}
	
	// apache POI ì—‘ì…€ë¡œ ë‹¤ìš´
	@GetMapping("/admin/excelDownload")
	public void downloadExcel(
	    @PathVariable("companyNo") String companyNo,
	    @RequestParam(required = false) String searchType,
	    @RequestParam(required = false) String searchWord,
	    HttpServletResponse response
	) throws IOException {
	    // 1. ì „ì²´ì‚¬ì› ë° ê²€ìƒ‰ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
		PaginationInfo<OrganizationVO> paging = new PaginationInfo<>(Integer.MAX_VALUE, 1); // ëª¨ë“  ë°ì´í„°
	    paging.setCurrentPage(1);
	    
	    SimpleCondition condition = new SimpleCondition();
	    condition.setSearchType(searchType);
	    condition.setSearchWord(searchWord);
	    paging.setSimpleCondition(condition);

	    paging = service.getAllEmployees(companyNo, paging);
	    List<OrganizationVO> data = paging.getDataList();
	    
	    // ì—‘ì…€ íŒŒì¼ ìƒì„±
	    Workbook workbook = new XSSFWorkbook();
	    Sheet sheet = workbook.createSheet("ì‚¬ì› ë¦¬ìŠ¤íŠ¸");

	    // í—¤ë”
	    Row headerRow = sheet.createRow(0);
	    String[] headers = {"ì‚¬ë²ˆ", "ì´ë¦„", "ë¶€ì„œ", "ì§ì±…", "ì´ë©”ì¼"};
	    for (int i = 0; i < headers.length; i++) {
	        Cell cell = headerRow.createCell(i);
	        cell.setCellValue(headers[i]);
	    }

	    // ë°ì´í„°
	    for (int i = 0; i < data.size(); i++) {
	        OrganizationVO emp = data.get(i);
	        Row row = sheet.createRow(i + 1);
	        row.createCell(0).setCellValue(emp.getEmpNo());
	        row.createCell(1).setCellValue(emp.getEmpNm());
	        row.createCell(2).setCellValue(emp.getDeptName());
	        row.createCell(3).setCellValue(emp.getPositionName());
	        row.createCell(4).setCellValue(emp.getEmpEmail());
	    }
	    
	    // ë™ì  íŒŒì¼ëª… ìƒì„±
	    String fileName = companyNo;
	    if (StringUtils.isNotBlank(searchType) && StringUtils.isNotBlank(searchWord)) {
	        switch (searchType) {
	            case "empNm":
	                fileName += "_ì´ë¦„ê²€ìƒ‰_" + searchWord;
	                break;
	            case "deptName":
	                fileName += "_ë¶€ì„œê²€ìƒ‰_" + searchWord;
	                break;
	            case "positionName":
	                fileName += "_ì§ì±…ê²€ìƒ‰_" + searchWord;
	                break;
	        }
	    }

	    // ë‚ ì§œ ì¶”ê°€
	    String today = new SimpleDateFormat("yyyyMMdd").format(new Date());
	    fileName += "_" + today + ".xlsx";

	    // íŒŒì¼ëª… ì¸ì½”ë”© (í•œê¸€ ê¹¨ì§ ë°©ì§€)
	    String encodedFileName = URLEncoder.encode(fileName, "UTF-8").replaceAll("\\+", "%20");
	    String contentDisposition = "attachment; filename*=UTF-8''" + encodedFileName;

	    // ì‘ë‹µ ì„¤ì •
	    response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
	    response.setHeader("Content-Disposition", contentDisposition);


	    // íŒŒì¼ ì¶œë ¥
	    workbook.write(response.getOutputStream());
	    workbook.close();
	}
}
