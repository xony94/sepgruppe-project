package kr.or.ddit.works.survey.controller;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import kr.or.ddit.works.survey.vo.SurveyVO;

/**
 * 
 * @author SJH
 * @since 2025. 3. 24.
 * @see
 *
 * <pre>
 * << Í∞úÏ†ïÏù¥Î†•(Modification Information) >>
 *   
 *   ÏàòÏ†ïÏùº      			ÏàòÏ†ïÏûê           ÏàòÏ†ïÎÇ¥Ïö©
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 24.     	SJH	          ÏµúÏ¥à ÏÉùÏÑ±
 *
 * </pre>
 */
@Controller
@RequestMapping("/{companyNo}/surveyApi")
public class SurveyProxyController {

    private static final String ACCESS_TOKEN = "LXs5ovMHyr4wSkLSS8XATbigcAhdK2MRdFnrpPtm8HGc0Z7yFQ6pzAMtSeY1swdDNxsOHhfU0xmu7yvo-m5Irkc0s6ZJsoYnhkAc-w22lNM6EcI7mxUD9p0MD-7owmfv";
    private static final String SURVEY_MONKEY_URL = "https://api.surveymonkey.com/v3/surveys";

    // ‚úÖ ÏÑ§Î¨∏ Î™©Î°ù Ï°∞Ìöå
    @GetMapping("/surveys")
    public ResponseEntity<String> getSurveys() {
        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpGet get = new HttpGet(SURVEY_MONKEY_URL);
            get.setHeader(	"Authorization", "Bearer " + ACCESS_TOKEN);
            get.setHeader("Content-Type", "application/json");

            try (CloseableHttpResponse response = client.execute(get)) {
                int status = response.getStatusLine().getStatusCode();
                String body = EntityUtils.toString(response.getEntity(), "UTF-8");

                if (status >= 200 && status < 300) {
                    return ResponseEntity.ok(body);
                } else {
                    return ResponseEntity.status(status).body("API Ïò§Î•ò: " + body);
                }
            }
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Ïò§Î•ò Î∞úÏÉù: " + e.getMessage());
        }
    }
 
    // ‚úÖ JSPÏóêÏÑú ÏÇ¨Ïö©ÌïòÍ∏∞ ÏúÑÌïú ÏÑ§Î¨∏ Î¶¨Ïä§Ìä∏ Ï°∞Ìöå
    @GetMapping("/list")
    public String getSurveyListFromApi(Model model, @PathVariable("companyNo") String companyNo) {
        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpGet get = new HttpGet(SURVEY_MONKEY_URL);
            get.setHeader("Authorization", "Bearer " + ACCESS_TOKEN);
            get.setHeader("Content-Type", "application/json");
            
            try (CloseableHttpResponse response = client.execute(get)) {
                String body = EntityUtils.toString(response.getEntity(), "UTF-8");

                // ‚õî Í∏∞Ï°¥: Map Î¶¨Ïä§Ìä∏
//                ObjectMapper mapper = new ObjectMapper();
//                JsonNode root = mapper.readTree(body);
//                List<Map<String, String>> surveyList = new ArrayList<>();
    //
//                for (JsonNode item : root.path("data")) {
//                    Map<String, String> survey = new HashMap<>();
//                    survey.put("id", item.get("id").asText());
//                    survey.put("title", item.get("title").asText());
//                    surveyList.add(survey);
//                }

                // ‚úÖ ÏàòÏ†ï: SurveyVO Î¶¨Ïä§Ìä∏
                ObjectMapper mapper = new ObjectMapper();
                JsonNode root = mapper.readTree(body);
                List<SurveyVO> surveyList = new ArrayList<>();

                for (JsonNode item : root.path("data")) {
                    SurveyVO survey = new SurveyVO();
                    survey.setSurveyId(item.get("id").asText());
                    survey.setTitle(item.get("title").asText());
                    surveyList.add(survey);
                }
                model.addAttribute("companyNo", companyNo);
                model.addAttribute("surveyList", surveyList);
                return "gw:survey/surveyList";
            }
        } catch (Exception e) {
            e.printStackTrace();
            model.addAttribute("error", "SurveyMonkey API Ï°∞Ìöå Ïã§Ìå®: " + e.getMessage());
            return "error";
        }
    }

    // ‚úÖ ÏÑ§Î¨∏ ÏÉùÏÑ± (surveyCreate)
    @PostMapping("/surveyCreate")
    public ResponseEntity<?> surveyCreate(Model model,@RequestBody String jsonBody, @PathVariable("companyNo") String companyNo) {
        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpPost post = new HttpPost(SURVEY_MONKEY_URL);
            post.setHeader("Authorization", "Bearer " + ACCESS_TOKEN);
            post.setHeader("Content-Type", "application/json");
            post.setEntity(new StringEntity(jsonBody, "UTF-8"));

            try (CloseableHttpResponse response = client.execute(post)) {
                int status = response.getStatusLine().getStatusCode();
                String responseBody = EntityUtils.toString(response.getEntity(), "UTF-8");

                if (status >= 200 && status < 300) {
                    return ResponseEntity.ok(responseBody);
                } else {
                    return ResponseEntity.status(status)
                            .body(Collections.singletonMap("error", "API Ïò§Î•ò: " + responseBody));
                }
            }
        } catch (Exception e) {
        	model.addAttribute("companyNo", companyNo);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Collections.singletonMap("error", e.getMessage()));
        }
    }
    
    // ‚úÖ ÏÑ§Î¨∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå (ÌîÑÎ°ùÏãú)
    @GetMapping("/surveys/{surveyId}/details")
    public String getSurveyDetailsPage(
            @PathVariable String companyNo,
            @PathVariable String surveyId,
            Model model) {

        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpGet get = new HttpGet("https://api.surveymonkey.com/v3/surveys/" + surveyId + "/details");
            get.setHeader("Authorization", "Bearer " + ACCESS_TOKEN);
            get.setHeader("Content-Type", "application/json");

            try (CloseableHttpResponse response = client.execute(get)) {
                int statusCode = response.getStatusLine().getStatusCode();
                String responseBody = EntityUtils.toString(response.getEntity(), "UTF-8");

                if (statusCode >= 200 && statusCode < 300) {
                    ObjectMapper mapper = new ObjectMapper();
                    JsonNode json = mapper.readTree(responseBody);

                    // üéØ JSONÏùÑ Î¨∏ÏûêÏó¥Î°ú modelÏóê Ï†ÑÎã¨ (JSPÏóêÏÑú JSON.parse Ìï¥ÏÑú Ïì∞Í∏∞ Ï¢ãÏùå)
                    model.addAttribute("surveyJson", json.toString());
                    model.addAttribute("surveyId", surveyId);
                    model.addAttribute("companyNo", companyNo);

                    return "gw:survey/survey";  // Tiles ÌÉÄÏùºÏ¶à Î∑∞ Ïù¥Î¶Ñ
                } else {
                    model.addAttribute("error", "ÏÑ§Î¨∏ Ï°∞Ìöå Ïã§Ìå®");
                    return "error";
                }
            }
        } catch (Exception e) {
            model.addAttribute("error", "ÏÑúÎ≤Ñ Ïò§Î•ò: " + e.getMessage());
            return "error";
        }
    }


}
