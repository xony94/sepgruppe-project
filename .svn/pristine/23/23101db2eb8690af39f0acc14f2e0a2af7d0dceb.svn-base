/** 
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 3. 26.     	SJH            ìµœì´ˆ ìƒì„± 
 * 2025. 3. 27.     	SJH            ìµœì¢…?
 *
 * </pre>
 */
 
 
// ì „ì—­ ë³€ìˆ˜: ì„¤ë¬¸ ì •ë³´ ì „ì²´ë¥¼ ì €ì¥
let surveyData = null;

// ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ì„ íƒëœ ì°¨íŠ¸ íƒ€ì… (ê¸°ë³¸ê°’ì€ 'pie')
let chartType = "pie";

// âœ… [1] í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì´ˆê¸° ì„¸íŒ…
document.addEventListener("DOMContentLoaded", () => {

    // ğŸ‘‰ ì°¨íŠ¸ íƒ€ì… ë“œë¡­ë‹¤ìš´ ì„ íƒì‹œ chartType ë³€ê²½ & ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    document.getElementById("chartTypeSelect").addEventListener("change", e => {
        chartType = e.target.value;        // ì„ íƒí•œ ì°¨íŠ¸ íƒ€ì… ì €ì¥
        fetchSurveyResults();              // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    });

    // ğŸ‘‰ ì„¤ë¬¸ IDê°€ ì¡´ì¬í•˜ë©´ ì„¤ë¬¸ ì •ë³´ & ì‘ë‹µ ë°ì´í„° ë¡œë”©
    if (surveyId) {
        fetchSurveyInfo();
        fetchSurveyResults();
    } else {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        window.location.href = `${contextPath}/${companyNo}/survey`;
    }
});

// âœ… [2] ì„¤ë¬¸ ê¸°ë³¸ ì •ë³´ (ì œëª©, ì„¤ëª… ë“±) ê°€ì ¸ì˜¤ê¸°
async function fetchSurveyInfo() {
    try {
        const response = await fetch(`${contextPath}/${companyNo}/surveyApi/surveys/${surveyId}/details/data`);
        if (!response.ok) throw new Error(`ì„¤ë¬¸ ì •ë³´ ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
        surveyData = await response.json();

        // âœ… ì œëª© ì²˜ë¦¬
        document.getElementById("surveyTitle").textContent = surveyData.title || "ì œëª© ì—†ìŒ";
		
		// âœ… ì„¤ëª… ì²˜ë¦¬ (í˜ì´ì§€ ë‚´ë¶€ì— ìˆì„ ìˆ˜ ìˆìŒ!)
        const rawDescription = (
            surveyData.description || 
            surveyData.pages?.[0]?.description || 
            ""
        ).trim();
        document.getElementById("surveyDescription").textContent = rawDescription.length > 0
            ? rawDescription
            : "(ì„¤ëª… ì—†ìŒ)";
			
    } catch (error) {
        console.error("ì„¤ë¬¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}

// âœ… [3] ì„¤ë¬¸ ì‘ë‹µ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function fetchSurveyResults() {
    try {
        const response = await fetch(`${contextPath}/${companyNo}/surveyApi/surveys/${surveyId}/responses`);
        if (!response.ok) throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
        const data = await response.json();

        processSurveyResults(data); // ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬
    } catch (error) {
        console.error("ì„¤ë¬¸ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
		document.getElementById("surveyDescription").textContent = "ì„¤ë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
}

// âœ… [4] ì‘ë‹µ ë°ì´í„°ë¥¼ ê°ê´€ì‹ / ì£¼ê´€ì‹ìœ¼ë¡œ ë¶„ë¦¬í•´ì„œ ì§‘ê³„
function processSurveyResults(data) {
    const questionStats = {};
    const openAnswers = {};

    data.data.forEach(response => {
        response.pages.forEach(page => {
            page.questions.forEach(question => {
                const questionId = question.id;

                // âœ… ì§ˆë¬¸ ì œëª© ì •í™•í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì •ë¨)
                const original = surveyData.pages.flatMap(p => p.questions).find(q => q.id === questionId);
                const questionText = original?.headings?.[0]?.heading?.trim() || "(ì œëª© ì—†ìŒ)";

                const answers = question.answers;
                const isOpenEnded = !original?.answers?.choices;

                if (isOpenEnded) {
                    if (!openAnswers[questionId]) {
                        openAnswers[questionId] = { text: questionText, values: [] };
                    }
                    answers?.forEach(ans => {
                        openAnswers[questionId].values.push(ans.text || "ë¯¸ì…ë ¥");
                    });
                } else {
                    if (!questionStats[questionId]) {
                        questionStats[questionId] = { text: questionText, counts: {} };
                    }
                    answers?.forEach(ans => {
                        const choiceText = findChoiceText(questionId, ans.choice_id) || "ê¸°íƒ€";
                        questionStats[questionId].counts[choiceText] = (questionStats[questionId].counts[choiceText] || 0) + 1;
                    });
                }
            });
        });
    });

    renderQuestions(questionStats, openAnswers);
}


// âœ… [5] ê°ê´€ì‹ ë¬¸í•­ì˜ ì„ íƒì§€ ID â†’ ì‹¤ì œ í…ìŠ¤íŠ¸ ë³€í™˜
function findChoiceText(questionId, choiceId) {
    const question = surveyData.pages.flatMap(p => p.questions).find(q => q.id === questionId);
    const choice = question?.answers?.choices?.find(c => c.id === choiceId);
    return choice?.text || null;
}

// âœ… [6] í™”ë©´ì— ì§ˆë¬¸ + ì‘ë‹µ ê²°ê³¼ ë Œë”ë§
function renderQuestions(stats, openAnswers) {
    const questionList = document.getElementById("questionList");
    questionList.innerHTML = ""; // ì´ˆê¸°í™”

    // âœ… ê°ê´€ì‹ ì§ˆë¬¸ + ì°¨íŠ¸ ë Œë”ë§
    Object.entries(stats).forEach(([questionId, question]) => {
        const container = document.createElement("div");
        container.classList.add("question-block");

        // âœ… ì§ˆë¬¸ ì œëª© ì¶”ê°€
        const title = document.createElement("h4");
        title.textContent = question.text;
        container.appendChild(title);

        // âœ… ì°¨íŠ¸ ìº”ë²„ìŠ¤ ì¶”ê°€
        const canvas = document.createElement("canvas");
        canvas.id = `chart_${questionId}`;
        canvas.style.maxWidth = "400px";
        canvas.style.maxHeight = "400px";
        container.appendChild(canvas);

        // âœ… DOMì— ë¶™ì´ê¸°
        questionList.appendChild(container);

        // âœ… ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        const labels = Object.keys(question.counts);
        const data = Object.values(question.counts);

        new Chart(canvas, {
            type: chartType,
            data: {
                labels,
                datasets: [{
                    label: "ì‘ë‹µ ìˆ˜",
                    data,
                    backgroundColor: ["#3498db", "#2ecc71", "#f1c40f", "#e74c3c", "#9b59b6"]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" }
                }
            }
        });
    });

    // âœ… ì£¼ê´€ì‹ ì§ˆë¬¸ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    Object.values(openAnswers).forEach(q => {
        const container = document.createElement("div");
        container.classList.add("question-block");
        container.innerHTML = `<h4>${q.text}</h4><ul>${q.values.map(ans => `<li>${ans}</li>`).join("")}</ul>`;
        questionList.appendChild(container);
    });
}

