document.addEventListener('DOMContentLoaded', function() {
    let calendarEl = document.getElementById('calendar'); // ìº˜ë¦°ë” ìš”ì†Œ
	
	document.body.addEventListener("click", function(event) { //ìˆ˜ì •ë²„íŠ¼í´ë¦­
	       if (event.target.id === "editSchdl") {
	           handleEditSchedule();
	       }
	   });
	   
   document.body.addEventListener("click", function(event) { //ì‚­ì œë²„íŠ¼í´ë¦­
          if (event.target.id === "deleteSchdl") {
              handleDeleteSchedule();
          }
      });   


    // FullCalendar ìƒì„±
    let calendar = new FullCalendar.Calendar(calendarEl, {
        plugins: [ FullCalendar.Interaction.default ], // ì¸í„°ë™ì…˜ í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€
        initialView: 'dayGridMonth',
        locale: 'ko',
        editable: true, // ìº˜ë¦°ë” ë‚´ì—ì„œ ì´ë²¤íŠ¸ ì´ë™ ê°€ëŠ¥
        droppable: true, // ì™¸ë¶€ ì´ë²¤íŠ¸ ë“œë¡­ ê°€ëŠ¥
        events: clist, // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸
        // ì¼ì • í´ë¦­ ì‹œ ëª¨ë‹¬ í˜¸ì¶œ (ìƒì„¸ì¡°íšŒ ì´ë²¤íŠ¸)
        eventClick: function(info) {
            let eventUrl = info.event.url;
            info.jsEvent.preventDefault();

            if (eventUrl) {
                $.ajax({
                    url: eventUrl,
                    type: "GET",
                    dataType: "html",
                    success: function(detail) {
						console.log("==================================================dsfksdjfk");
						console.log(detail);
                        $("#scheduleModal .modal-body").html(detail);
                        $("#scheduleModal").modal("show");
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX ì˜¤ë¥˜:", status, error);
                        alert("ì¼ì • ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }
        },


        // ë“œë˜ê·¸í•´ì„œ ì´ë²¤íŠ¸ ì¶”ê°€ ê¸°ëŠ¥ (ë‚˜ì¤‘ì— í•  ì˜ˆì •)
        eventReceive: function(info) {
            console.log("ë“œë¡­ëœ ì´ë²¤íŠ¸:", info.event);
        },
		

        // ğŸ“Œ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
        dateClick: function(info) {
            $.ajax({
                url: `${contextPath}/${companyNo}/schedule/form`,  // JSP í¼ì„ ê°€ì ¸ì˜¤ëŠ” URL
                type: "GET",
                dataType: "html",
                success: function(resp) {
					
                    $("#scheduleModal .modal-body").empty().html(resp);
					
                    $("#scheduleModal").modal("show");
					
					// ì¼ì • ì‹œì‘ì¼ í•„ë“œ ìë™ ì„¤ì •
					$("#scheduleModal").on("shown.bs.modal", function() {
					    $("#schdlBgngYmd").val(info.dateStr); // ì„ íƒí•œ ë‚ ì§œ ìë™ ì…ë ¥
					});
	
					//í¼ ì œì¶œ ì´ë²¤íŠ¸
					$("#scheduleModal").on("submit", "#scheduleForm", function(event) {
						event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
						saveSchedule();
					});
					
                },
                error: function(xhr, status, error) {
                    console.error("AJAX ì˜¤ë¥˜:", status, error);
                    alert("ì¼ì • ë“±ë¡ í¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
		
    });

    calendar.render();



	// ì¼ì • ì €ì¥ í•¨ìˆ˜ (POST ìš”ì²­)
	function saveSchedule() {
	    let formData = $("#scheduleForm").serialize(); // í¼ ë°ì´í„° ì§ë ¬í™”
	
	    $.ajax({
	        url: `${contextPath}/${companyNo}/schedule/createSchedule.ajax`, // ì¼ì • ì €ì¥ API URL
	        type: "POST",
	        data: formData,
	        dataType: "json",
	        success: function(resp) {
				console.log(resp.cnt);
				
				if (resp.cnt == 1) {
				    alert("ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
				    $("#scheduleModal").modal("hide"); // ëª¨ë‹¬ ë‹«ê¸°
				    location.reload(); // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
				} else {
				    alert("ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
				}
				
	        },
	        error: function(xhr, status, error) {
	            console.error("AJAX ì˜¤ë¥˜:", status, error);
	            alert("ì¼ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	        }
	    });
	}

	// ìˆ˜ì •ë²„íŠ¼
	function handleEditSchedule() {
	    // ëª¨ë“  ë¼ë””ì˜¤ ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
	    let radioButtons = document.querySelectorAll('input[name="schdlEdit"]');
	
	    // í•˜ë‚˜ë¼ë„ ì²´í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
	    let isChecked = Array.from(radioButtons).some(radio => radio.checked);
	
	    if (!isChecked) {
	        // ë¼ë””ì˜¤ ë²„íŠ¼ì´ ì²´í¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê²½ê³ ì°½ í‘œì‹œ í›„ í•¨ìˆ˜ ì¢…ë£Œ
	        Swal.fire({
	            icon: "warning",
	            title: "ì²´í¬ í•„ìš”!",
	            text: "ë¨¼ì € ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”!",
	            confirmButtonText: "í™•ì¸",
	            confirmButtonColor: "#ff9800",
	        });
	        return;
	    }
	
	    // ë¼ë””ì˜¤ ë²„íŠ¼ì´ ì²´í¬ëœ ê²½ìš° ì •ìƒ ì‹¤í–‰
	    Swal.fire({
	        icon: "success",
	        title: "ì„±ê³µ!",
	        text: "ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!",
	        confirmButtonText: "í™•ì¸",
	        confirmButtonColor: "#28a745",
	    });
	}
	
	//ì‚­ì œ
	function handleDeleteSchedule() {
	    let selectedRadio = document.querySelector('input[name="schdlEdit"]:checked');

	    if (!selectedRadio) {
	        Swal.fire({
	            icon: "warning",
	            title: "ì²´í¬ í•„ìš”!",
	            text: "ì‚­ì œí•  ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”!",
	            confirmButtonText: "í™•ì¸",
	            confirmButtonColor: "#ff9800",
	        });
	        return;
	    }

	    let schdlNo = selectedRadio.value; // ì„ íƒëœ ì¼ì • ë²ˆí˜¸

	    Swal.fire({
	        title: "ì‚­ì œ í™•ì¸",
	        text: "ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
	        icon: "warning",
	        showCancelButton: true,
	        confirmButtonColor: "#d33",
	        cancelButtonColor: "#3085d6",
	        confirmButtonText: "ì‚­ì œ",
	        cancelButtonText: "ì·¨ì†Œ"
	    }).then((result) => {
	        if (result.isConfirmed) {
	            $.ajax({
	                url: `${contextPath}/${companyNo}/schedule/deleteSchedule.ajax/${schdlNo}`,
	                type: "DELETE",
	                success: function(resp) {
	                    if (resp.cnt == 1) {
	                        Swal.fire("ì‚­ì œ ì™„ë£Œ!", "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success").then(() => {
	                            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
	                        });
	                    } else {
	                        Swal.fire("ì‚­ì œ ì‹¤íŒ¨!", "ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "error");
	                    }
	                },
	                error: function(xhr, status, error) {
	                    console.error("AJAX ì˜¤ë¥˜:", status, error);
	                    Swal.fire("ì˜¤ë¥˜ ë°œìƒ!", "ì¼ì • ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
	                }
	            });
	        }
	    });
	}

});