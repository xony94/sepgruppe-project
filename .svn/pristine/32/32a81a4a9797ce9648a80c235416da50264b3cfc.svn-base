package kr.or.ddit.works.schedule.controller;

import java.security.Provider.Service;
import java.time.LocalDate;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.ddit.validate.InsertGroup;
import kr.or.ddit.works.reservation.vo.ReservationVO;
import kr.or.ddit.works.schedule.service.ScheduleService;
import kr.or.ddit.works.schedule.vo.ScheduleVO;
import lombok.extern.slf4j.Slf4j;

/**
 * 일정관리 컨트롤러
 * @author JYS
 * @since 2025. 3. 16.
 * @see
 *
 * <pre>
 * << 개정이력(Modification Information) >>
 *   
 *   수정일      			수정자           수정내용
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 16.     	JYS	          최초 생성
 *
 * </pre>
 */
@Slf4j
@Controller
@RequestMapping("/{companyNo}/schedule")
public class ScheduleController {
	
	public static final String MODELNAME = "schedule";
	
	@Autowired
	private ScheduleService scheduleService;
	
	@GetMapping("")
	public String readScheduleList(@PathVariable("companyNo") String companyNo
		, Model model) {
	    List<ScheduleVO> scheduleList = scheduleService.readScheduleList();
	    
	    if (scheduleList == null || scheduleList.isEmpty()) {
	        System.out.println("일정이 없습니다");
	    } else {
	        System.out.println("일정있음");
	    }
	    
	    System.out.println("================================mh");
	    for(int i=0;i<scheduleList.size();i++) {
	    	System.out.println(scheduleList.get(i));
	    	
	    }
	    
	    
	    model.addAttribute("scheduleList", scheduleList);
	    model.addAttribute("companyNo", companyNo);
	    return "gw:schedule/scheduleList";
	}
	
//	@GetMapping("/{schdlNo}.do")
//	public ScheduleVO readSchedule(@PathVariable("schdlNo") int schdlNo) {
//		
//		ScheduleVO sch = scheduleService.readSchedule(schdlNo);
//		
//		return scheduleService.readSchedule(schdlNo);
//	}
	@GetMapping("/scheduleDetail.do")
	public String doGet(
			@RequestParam("what") String schdlNo
			, Model model
	) {
		int scheduleId = Integer.parseInt(schdlNo);
		List<ScheduleVO> schedule = scheduleService.readSchedule(scheduleId);
		model.addAttribute("schedule", schedule);
		
		return "groupware/schedule/scheduleDetail";
		
	}
	
	
	 // 일정 등록 폼 반환 (JSP)
    @GetMapping("/form")
    public String scheduleForm() {
        return "groupware/schedule/scheduleForm";  // scheduleForm.jsp 반환
    }
	
    
    
	@ResponseBody
	@PostMapping("/createSchedule.ajax")
	public ScheduleVO createSchedule(
			@ModelAttribute(MODELNAME) ScheduleVO pvo,
			HttpSession session,
			Model model,
			Authentication authentication){
//		List<ScheduleVO> schedule = scheduleService.readSchedule(scheduleId);
//		model.addAttribute("schedule", schedule);
		pvo.setEmpId(authentication.getName());

        System.out.println("=============================================mh1");
        System.out.println(pvo);
        System.out.println(authentication.getName());
		
		
        int cnt = scheduleService.createSchedule(pvo);
        
        System.out.println("=============================================mh2");
        System.out.println(cnt);
        ScheduleVO rvo = new ScheduleVO();
        rvo.setCnt(cnt);
		
		return rvo;
	}
	
	@DeleteMapping("/deleteSchedule.ajax/{schdlNo}")
	public String deleteSchedule(@PathVariable("schdlNo") int schdlNo) {
	    scheduleService.deleteSchedule(schdlNo);
	    return "redirect:/{companyNo}/schedule"; // 삭제 후 일정 목록 페이지로 이동
	}
	
	
	
	
	
//	@GetMapping("/scheduleInsert.do")
//	public String insertScheduleForm(Model model) {
//	    model.addAttribute("schedule", new ScheduleVO());
//	    return "groupware/schedule/scheduleForm";
//	}
//
//	
//	@PostMapping("/scheduleInsert.do")
//	public String insertSchedule(
//		@Validated(InsertGroup.class) @ModelAttribute(MODELNAME) ScheduleVO schedule
//		, BindingResult errors
//		, RedirectAttributes redirectAttributes
//	) {
//	if (!errors.hasErrors()) {
//		scheduleService.createSchedule(schedule); //db에 저장
//		return "redirect:/{companyNo}/schedule";
//	} else {
//		redirectAttributes.addFlashAttribute(MODELNAME, schedule);
//		String errorAttrName = BindingResult.MODEL_KEY_PREFIX + MODELNAME;
//		redirectAttributes.addFlashAttribute(errorAttrName, errors);
//	}
//	return "redirect:/scheduleInsert.do";
//		
//	}
	
	
	
    
    


	
	
}
