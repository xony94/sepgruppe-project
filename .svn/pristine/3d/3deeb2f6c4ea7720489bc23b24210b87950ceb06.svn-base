<!-- 
 * == 개정이력(Modification Information) ==
 *   
 *   수정일      			수정자           수정내용
 *  ============   	============== =======================
 *  2025. 3. 14.     	JYS            최초 생성
 *
-->
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.io.*, java.util.*, javax.servlet.*, javax.servlet.http.*, org.apache.commons.fileupload.*, org.apache.commons.fileupload.disk.*, org.apache.commons.fileupload.servlet.*, com.google.api.client.auth.oauth2.Credential, com.google.api.client.googleapis.auth.oauth2.GoogleCredential, com.google.api.client.googleapis.javanet.GoogleNetHttpTransport, com.google.api.client.http.InputStreamContent, com.google.api.client.http.javanet.NetHttpTransport, com.google.api.services.drive.Drive, com.google.api.services.drive.DriveScopes, com.google.api.services.drive.model.File" %>
<%
    try {
        // 파일 업로드 처리
        boolean isMultipart = ServletFileUpload.isMultipartContent(request);
        if (isMultipart) {
            DiskFileItemFactory factory = new DiskFileItemFactory();
            ServletFileUpload upload = new ServletFileUpload(factory);
            List<FileItem> items = upload.parseRequest(request);

            for (FileItem item : items) {
                if (!item.isFormField()) {
                    String fileName = item.getName();
                    InputStream fileContent = item.getInputStream();

                    // Google Drive API 연동
                    NetHttpTransport httpTransport = GoogleNetHttpTransport.newTrustedTransport();
                    Credential credential = GoogleCredential
                            .fromStream(application.getResourceAsStream("${pageContext.request.contextPath }/resources/credentials.json"))
                            .createScoped(Collections.singleton(DriveScopes.DRIVE));
                    Drive driveService = new Drive.Builder(httpTransport, com.google.api.client.json.gson.GsonFactory.getDefaultInstance(), credential)
                            .setApplicationName("Your Application Name")
                            .build();

                    File fileMetadata = new File();
                    fileMetadata.setName(fileName);
                    InputStreamContent mediaContent = new InputStreamContent(item.getContentType(), fileContent);
                    File uploadedFile = driveService.files().create(fileMetadata, mediaContent)
                            .setFields("id")
                            .execute();

                    out.println("File uploaded successfully. File ID: " + uploadedFile.getId());
                }
            }
        }
    } catch (Exception e) {
        out.println("Failed to upload file: " + e.getMessage());
    }
%>

<!DOCTYPE html>
<html>
<head>
    <title>Google Drive File Upload</title>
</head>
<body>
    <h1>Upload File to Google Drive</h1>
    <form action="upload.jsp" method="post" enctype="multipart/form-data">
        <input type="file" name="file" />
        <input type="submit" value="Upload" />
    </form>
</body>
</html>