/** 
 * <pre>
 * << 개정이력(Modification Information) >>
 *   
 *   수정일      			수정자           수정내용
 *  -----------   	-------------    ---------------------------
 * 2025. 4. 8.     	SHJ            최초 생성
 *
 * </pre>
 */

if (typeof alarmConnected === 'undefined') {
  var alarmConnected = false;
}
// 🔔 Notification 유틸리티 함수
function showPushNotification(title, content, onClickCallback) {
	
	// 🔔 알림 권한 요청
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then(function (permission) {
            console.log("알림 권한 상태:", permission);
        });
    }
		
    if (Notification.permission === "granted") {
        const notification = new Notification(title, {
            body: content
        });

        // 클릭 이벤트 처리
        notification.onclick = function(event) {
            event.preventDefault();
            if (typeof onClickCallback === "function") {
                onClickCallback();
            }
        };
    }
}
function connectAlarm(userId) {
	
	if (alarmConnected) return;
	
    const socket = new SockJS("/sep/stomp");
    alarmClient = Stomp.over(socket);

    alarmClient.connect({}, function(frame) {
        console.log("🔔 알림 연결 완료");

        // 예: /topic/alarm/{userId} 구독
    alarmClient.subscribe("/topic/alarm/" + userId, function(message) {
        const alarm = JSON.parse(message.body);
		
		// 자기 자신이 보낸 메시지는 제외하고 알림 표시
		if (alarm.senderEmpId !== userId) {
			const senderName = alarm.organization?.empNm || "알 수 없음";
			const roomId = alarm.roomId; // 메시지에 포함된 채팅방 ID

			showPushNotification("📬 새 메시지", senderName + ": " + alarm.msgContent, function() {
				openChatRoom(roomId); // 👈 클릭 시 이 함수 실행
			});
		}
    });
    });
}

function openChatRoom(roomId) {
    openMessengerWindow(); // 1. 메신저 창 열기

	setTimeout(function () {
	        if (sepMessenger.$("#listLink").length) {
	            sepMessenger.$("#listLink")[0].click();
	        }

	        // 3. 채팅방 리스트 로딩 대기
	        waitForRoomToAppear(roomId, 0); // roomId를 가진 방이 나올 때까지 대기
	    }, 300);
}


function waitForRoomToAppear(roomId, tryCount) {
    const targetRoom = sepMessenger.$("li.chat-room-row[data-roomid='" + roomId + "']");

    if (targetRoom.length) {
        console.log("✅ 방 찾음:", roomId);
        targetRoom.trigger("click");
    } else if (tryCount < 20) {
        // 아직 방이 안 뜬 경우, 0.3초 후 재시도 (최대 20번 = 약 6초 대기)
        setTimeout(function () {
            waitForRoomToAppear(roomId, tryCount + 1);
        }, 300);
    } else {
        console.warn("❗ 채팅방을 찾지 못했습니다:", roomId);
    }
}

$(document).ready(function () {
    const userId = $(".name").data("emp-id"); // 로그인한 사용자 ID 가져오기
    connectAlarm(userId); // 알림 구독 시작
});