package kr.or.ddit.works.alarm.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import kr.or.ddit.works.alarm.service.OneSignalService;
import kr.or.ddit.works.alarm.vo.AlarmHistoryVO;
import kr.or.ddit.works.project.vo.ProjectVO;
import kr.or.ddit.works.project.vo.TaskVO;
import lombok.RequiredArgsConstructor;

/**
 * 알람 컨트롤러
 * @author JYS
 * @since 2025. 3. 16.
 * @see
 *
 * <pre>
 * << 개정이력(Modification Information) >>
 *   
 *   수정일      			수정자           수정내용
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 16.     	JYS	          최초 생성
 *
 * </pre>
 */
@RequiredArgsConstructor
@RequestMapping("/{companyNo}/alarm")
@RestController
public class GWAlarmController {

	@Autowired
    private OneSignalService oneSignalService;
	
	private final SimpMessagingTemplate messagingTemplate;
	
	
 	@GetMapping("/send")
    public String sendAlarmForm(
    ) {
        return "sep:alarm/alarmSendForm";
    }
	 	
 	@PostMapping("/send/alarm")
 	public void sendAlarm(@RequestBody AlarmHistoryVO alarm) {
 		messagingTemplate.convertAndSend("/topic/alarm/" + alarm.getEmpId(), alarm);
 	}
 	
 	public void sendProjectAlarm(ProjectVO project, String receiverEmpId) {
 	    AlarmHistoryVO alarm = new AlarmHistoryVO();
 	    alarm.setAlarmNm(project.getProjectTitle());
 	    alarm.setEmpId(receiverEmpId);
 	    alarm.setAlarmCategoryNo(project.getProjectNo());

 	    // 전송 경로: /topic/project/{userId}
 	    messagingTemplate.convertAndSend("/topic/project/" + receiverEmpId, alarm);
 	}
 	
 	public void sendTaskAlarm(TaskVO task, String receiverEmpId, long taskNo) {
 		AlarmHistoryVO alarm = new AlarmHistoryVO();
 		alarm.setAlarmNm(task.getProjectTitle());
 		alarm.setAlarmContent(task.getTaskTitle());
 		alarm.setEmpId(receiverEmpId);
 		alarm.setAlarmCategoryNo(taskNo);
 		
 		messagingTemplate.convertAndSend("/topic/task/" + receiverEmpId, alarm);
 	}
}
