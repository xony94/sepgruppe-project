<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.works.mybatis.mappers.CommunityMapper">

	<resultMap type="CommunityVO" id="communityMap" autoMapping="true">
		<id property="communityNo" column="COMMUNITY_NO"/>
		<result property="empId" column="EMP_ID"/> <!-- 방장 아이디 -->
		<result property="memberCount" column="MEMBER_COUNT"/>
		<result property="communityNm" column="COMMUNITY_NM"/>
		<result property="communityContent" column="COMMUNITY_CONTENT"/>
		<result property="communityCreatedAt" column="COMMUNITY_CREATED_AT"/>
		<result property="communityIsClosed" column="COMMUNITY_IS_CLOSED"/>
		<result property="closureReason" column="CLOSURE_REASON"/>
		<result property="closureTimestamp" column="CLOSURE_TIMESTAMP"/>
		<result property="joinedEmpId" column="JOINED_EMP_ID"/>
		<result property="postCount" column="POST_COUNT"/>


		<collection property="joinStatus" ofType="JoinStatusVO">
			<id property="requestNo" column="REQUEST_NO"/>
			<result property="userStatus" column="USER_STATUS"/>
			<result property="requestDate" column="REQUEST_DATE"/>
			<result property="rejectionReason" column="REJECTION_REASON"/>
		</collection>

		<collection property="employee" ofType="EmployeeVO">
			<id property="empId" column="EMP_ID"/>
			<result property="empNm" column="EMP_NM"/>
		</collection>

		<collection property="board" ofType="BoardVO">
			<id property="boardNo" column="BOARD_NO"/>
			<result property="boardNm" column="BOARD_NM"/>
			<result property="boardContent" column="BOARD_CONTENT"/>

			<collection property="post" ofType="PostVO">
				<id property="postNo" column="POST_NO"/>
	            <result property="memberNo" column="MEMBER_NO"/>
	            <result property="postTitle" column="POST_TITLE"/>
	            <result property="postContent" column="POST_CONTENT"/>
	            <result property="postCreatedAt" column="POST_CREATED_AT"/>
	            <result property="postUpdatedAt" column="POST_UPDATED_AT"/>
	            <result property="postLikeCount" column="POST_LIKE_COUNT"/>
	            <result property="postIsDraft" column="POST_IS_DRAFT"/>
	            <result property="postAllowComments" column="POST_ALLOW_COMMENTS"/>
	            <result property="fileGroupNo" column="FILE_GROUP_NO"/>
	            <result property="postViewCount" column="POST_VIEW_COUNT"/>
			</collection>
		</collection>


	</resultMap>

	<!-- extends : 위 MAP 상속 (위의 MAP + alpa) -->
	<resultMap type="CommunityVO" id="communityMemberMap" extends="communityMap">
		<collection property="communityMember" ofType="CommunityMemberVO" autoMapping="false">
			<id property="memberNo" column="MEMBER_NO" />
			<result property="memberJoinDate" column="MEMBER_JOIN_DATE"/>
			<result property="memberRole" column="MEMBER_ROLE"/>
			<result property="memberActivityStatus" column="MEMBER_ACTIVITY_STATUS"/>
			<association property="employee" javaType="EmployeeVO" autoMapping="false">
				<result property="empId" column="EMPMEMBERID"/> <!-- 방장포함 회원 아이디 -->
				<result property="empNm" column="EMPMEMBERNM"/> <!-- 방장포함 회원명 -->
			</association>
		</collection>
	</resultMap>

	<!-- 가입된 커뮤니티 회원정보 조회 -->
	<select id="communityMember" resultMap="communityMemberMap">
		SELECT
			C.MEMBER_NO
			, C.COMMUNITY_NO
		    , C.EMP_ID AS EMPMEMBERID
		    , C.MEMBER_ROLE
		    , E.EMP_NM AS EMPMEMBERNM
		FROM
		    COMMUNITY_MEMBER C
		LEFT JOIN
			EMPLOYEE E ON C.EMP_ID = E.EMP_ID
		WHERE
		    COMMUNITY_NO = #{communityNo}
	</select>

	<!-- 가입된 커뮤니티 방 정보 조회 -->
	<select id="memberCommunityList" resultMap="communityMemberMap">
		SELECT
		    CM.COMMUNITY_NO
		    , CM.MEMBER_NO
		    , CM.EMP_ID
		    , CM.MEMBER_JOIN_DATE
		    , CM.MEMBER_ROLE
		    , CM.MEMBER_ACTIVITY_STATUS
		    , JS.USER_STATUS
		    , JS.REQUEST_DATE
		    , C.COMMUNITY_NO
		    , C.COMMUNITY_NM
		    , C.COMMUNITY_CONTENT
		    , C.COMMUNITY_CREATED_AT
		    , C.COMMUNITY_IS_CLOSED
		    , (SELECT EMP_NM FROM EMPLOYEE E WHERE E.EMP_ID = C.EMP_ID) AS EMP_NM
		    , (
		        SELECT
		            COUNT(*)
		        FROM
		            POST P
		        JOIN BOARD B ON P.BOARD_NO = B.BOARD_NO
		        WHERE B.COMMUNITY_NO = C.COMMUNITY_NO
		        AND P.POST_IS_DRAFT = 'N'
		    ) AS POST_COUNT
		    , (
		        SELECT
		            COUNT(*)
		        FROM
		            COMMUNITY_MEMBER CM2
		        WHERE CM2.COMMUNITY_NO = C.COMMUNITY_NO
		    ) AS MEMBER_COUNT
		FROM
		    COMMUNITY_MEMBER CM
		LEFT JOIN
		    JOIN_STATUS JS
		    ON CM.REQUEST_NO = JS.REQUEST_NO
		    AND CM.COMMUNITY_NO = JS.COMMUNITY_NO
		    AND CM.EMP_ID = JS.EMP_ID
		LEFT JOIN
		    COMMUNITY C
		    ON CM.COMMUNITY_NO = C.COMMUNITY_NO
		LEFT JOIN
		    EMPLOYEE E
		    ON CM.EMP_ID = E.EMP_ID
		WHERE
		    CM.EMP_ID = #{empId}
	</select>

	<!-- 커뮤니티방 전체 목록 조회 -->
	<select id="communityList" resultMap="communityMap">
		SELECT
		    C.COMMUNITY_NM
		    , COUNT(CM.MEMBER_NO) AS MEMBER_COUNT
		    , E.EMP_NM
		    , TO_CHAR(C.COMMUNITY_CREATED_AT, 'YYYY-MM-DD') AS COMMUNITY_CREATED_AT
		    , C.COMMUNITY_NO
		    , CM2.EMP_ID AS JOINED_EMP_ID
		FROM
		    COMMUNITY C
		LEFT JOIN
		    COMMUNITY_MEMBER CM ON C.COMMUNITY_NO = CM.COMMUNITY_NO
		LEFT JOIN
		    EMPLOYEE E ON C.EMP_ID = E.EMP_ID
		LEFT JOIN
		    COMMUNITY_MEMBER CM2 ON C.COMMUNITY_NO = CM2.COMMUNITY_NO AND CM2.EMP_ID = #{empId}
		WHERE
		    C.COMMUNITY_IS_CLOSED = 'N'
		GROUP BY
		    C.COMMUNITY_NM
		    , E.EMP_NM
		    , C.COMMUNITY_CREATED_AT
		    , C.COMMUNITY_NO
		    , CM2.EMP_ID
	</select>

	<!-- 커뮤니티방의 게시글 전체 조회 -->
	<select id="boardList" resultMap="communityMap">
		SELECT
		    C.COMMUNITY_NO
		    , C.COMMUNITY_NM
		    , C.COMMUNITY_CONTENT
		    , C.COMMUNITY_CREATED_AT
		    , B.BOARD_NO
		    , B.BOARD_NM
		    , B.BOARD_CONTENT
		    , P.POST_NO
		    , P.POST_TITLE
		    , P.MEMBER_NO
		    , TO_CHAR(P.POST_CREATED_AT, 'YYYY-MM-DD') AS POST_CREATED_AT
		    , P.POST_LIKE_COUNT
		    , P.POST_IS_DRAFT
		    , P.POST_ALLOW_COMMENTS
		    , P.POST_VIEW_COUNT
		    , CO.REPLY_NO
		    , CO.REPLY_CONTENT
		    , CO.REPLY_CREATE_DATE
		    , L.LIKE_NO
		    , L.LIKE_IS_ACTIVE
		    , CM.MEMBER_ROLE
		    , M.EMP_NM AS EMP_NM
		FROM
		    COMMUNITY C
		    LEFT JOIN BOARD B ON C.COMMUNITY_NO = B.COMMUNITY_NO
		    LEFT JOIN POST P ON B.BOARD_NO = P.BOARD_NO
		    LEFT JOIN COMMENTS CO ON P.POST_NO = CO.POST_NO
		    LEFT JOIN LIKES L ON P.POST_NO = L.POST_NO
		    LEFT JOIN COMMUNITY_MEMBER CM ON CM.COMMUNITY_NO = C.COMMUNITY_NO
		    AND CM.MEMBER_NO = P.MEMBER_NO
		    LEFT JOIN EMPLOYEE M ON M.EMP_ID = P.EMP_ID
		WHERE
		    C.COMMUNITY_NO = #{communityNo}
		ORDER BY
		    B.BOARD_NO, P.POST_NO, CO.REPLY_NO
	</select>

	<!-- 게시판에 해당되는 게시글 조회 -->
	<select id="boardNoList" resultMap="communityMap">
		SELECT
		    C.COMMUNITY_NO
		    , C.COMMUNITY_NM
		    , C.COMMUNITY_CONTENT
		    , C.COMMUNITY_CREATED_AT
		    , B.BOARD_NO
		    , B.BOARD_NM
		    , B.BOARD_CONTENT
		    , P.POST_NO
		    , P.POST_TITLE
		    , P.MEMBER_NO
		    , TO_CHAR(P.POST_CREATED_AT, 'YYYY-MM-DD') AS POST_CREATED_AT
		    , P.POST_LIKE_COUNT
		    , P.POST_IS_DRAFT
		    , P.POST_ALLOW_COMMENTS
		    , P.POST_VIEW_COUNT
		    , CO.REPLY_NO
		    , CO.REPLY_CONTENT
		    , CO.REPLY_CREATE_DATE
		    , L.LIKE_NO
		    , L.LIKE_IS_ACTIVE
		    , CM.MEMBER_ROLE
		    , M.EMP_NM AS EMP_NM
		FROM
		    COMMUNITY C
		    LEFT JOIN BOARD B ON C.COMMUNITY_NO = B.COMMUNITY_NO
		    LEFT JOIN POST P ON B.BOARD_NO = P.BOARD_NO
		    LEFT JOIN COMMENTS CO ON P.POST_NO = CO.POST_NO
		    LEFT JOIN LIKES L ON P.POST_NO = L.POST_NO
		    LEFT JOIN COMMUNITY_MEMBER CM ON CM.COMMUNITY_NO = C.COMMUNITY_NO
		    AND CM.MEMBER_NO = P.MEMBER_NO
		    LEFT JOIN EMPLOYEE M ON M.EMP_ID = P.EMP_ID
		WHERE
		    P.BOARD_NO = #{boardNo}
		ORDER BY
		    B.BOARD_NO, P.POST_NO, CO.REPLY_NO
	</select>

	<!-- communityNo 가져오기 -->
	<select id="communityNo">
		SELECT
			NVL(MAX(COMMUNITY_NO), 0) + 1
		FROM COMMUNITY
	</select>

	<!-- requestNo 가져오기 -->
	<select id="requestNo">
		SELECT
			NVL(MAX(REQUEST_NO), 0) + 1
		FROM JOIN_STATUS
	</select>


	<!-- 커뮤니티방 개설 (COMMUNITY 테이블 INSERT) -->
	<insert id="insertRoom">
		INSERT INTO COMMUNITY (
		    COMMUNITY_NO
		    , COMMUNITY_NM
		    , COMMUNITY_CONTENT
		    , COMMUNITY_CREATED_AT
		    , EMP_ID
		) VALUES (
		    #{communityNo,jdbcType=NUMERIC}
		    , #{communityNm,jdbcType=VARCHAR}
		    , #{communityContent,jdbcType=VARCHAR}
		    , SYSDATE
		    , #{empId,jdbcType=VARCHAR}
		)
	</insert>

	<!-- 커뮤니티방 개설 (COMMUNITY_MEMBER 테이블 INSERT) -->
	<insert id="insertRoomMember">
		INSERT INTO COMMUNITY_MEMBER (
		    MEMBER_NO
		    , REQUEST_NO
		    , COMMUNITY_NO
		    , EMP_ID
		    , MEMBER_JOIN_DATE
		    , MEMBER_ROLE
		    , MEMBER_ACTIVITY_STATUS
		) VALUES (
		    (SELECT NVL(MAX(MEMBER_NO), 0) + 1 FROM COMMUNITY_MEMBER)
			, #{requestNo,jdbcType=NUMERIC}
			, #{communityNo,jdbcType=NUMERIC}
			, #{empId,jdbcType=VARCHAR}
			, SYSDATE
			, '방 주인'
			, '활동중'
		)
	</insert>

	<!-- 커뮤니티방 개설 (JOIN_STATUS 테이블 INSERT) -->
	<insert id="insertStatusMember">
		INSERT INTO JOIN_STATUS (
		    REQUEST_NO
		    , COMMUNITY_NO
		    , EMP_ID
		    , USER_STATUS
		    , REQUEST_DATE
		) VALUES (
		    #{requestNo,jdbcType=NUMERIC}
			, #{communityNo,jdbcType=NUMERIC}
			, #{empId,jdbcType=VARCHAR}
			, '승인'
			, SYSDATE
		)
	</insert>

	<!-- 게시판 추가 -->
	<insert id="insertBoard">
		INSERT INTO BOARD(
			BOARD_NO
			, COMMUNITY_NO
			, BOARD_NM
			, BOARD_CONTENT
		) VALUES (
			(SELECT NVL(MAX(BOARD_NO), 0) + 1 FROM BOARD)
			, #{communityNo,jdbcType=NUMERIC}
			, #{boardNm,jdbcType=VARCHAR}
			, #{boardContent,jdbcType=VARCHAR}
		)
	</insert>

	<!-- 게시글 상세조회 -->
	<select id="selectPostDetail" resultType="CommunityVO" resultMap="communityMemberMap">
		SELECT
		    P.POST_NO
		  , P.BOARD_NO
		  , P.MEMBER_NO
		  , P.POST_TITLE
		  , P.POST_CONTENT
		  , TO_CHAR(P.POST_CREATED_AT, 'YYYY-MM-DD') AS POST_CREATED_AT
		  , P.POST_UPDATED_AT
		  , P.POST_LIKE_COUNT
		  , P.POST_IS_DRAFT
		  , P.POST_ALLOW_COMMENTS
		  , P.FILE_GROUP_NO
		  , P.EMP_ID AS EMPMEMBERID
		  , P.POST_VIEW_COUNT
		  , E.EMP_NM
		  , B.BOARD_NM
		FROM
		    POST P
		LEFT JOIN EMPLOYEE E ON P.EMP_ID = E.EMP_ID
		LEFT JOIN BOARD B ON P.BOARD_NO = B.BOARD_NO
		WHERE
			POST_NO = #{postNo,jdbcType=NUMERIC}
	</select>

	<!-- 좋아요 등록 취소를 위한 게시글에 해당하는 좋아요 수 조회 -->
	<select id="selectLike">
		SELECT
		    COUNT(*) AS LIKE_NO
		FROM
		    LIKES
		WHERE
		    POST_NO = #{postNo,jdbcType=NUMERIC}
	</select>

	<!-- 좋아요 상태관리를 위한 조회 -->
	<select id="likeStatus">
		SELECT
			LIKE_NO
			, LIKE_IS_ACTIVE
		FROM
			LIKES
		WHERE
			POST_NO = #{postNo,jdbcType=NUMERIC}
		AND
			MEMBER_NO = #{memberNo,jdbcType=NUMERIC}
	</select>

	<!-- 좋아요 등록 (LIKE 테이블 INSERT)-->
	<insert id="likeInsert">
		INSERT INTO LIKES(
			LIKE_NO
			, POST_NO
			, MEMBER_NO
			, LIKE_IS_ACTIVE
		) VALUES (
			(SELECT NVL(MAX(LIKE_NO), 0) + 1 FROM LIKES)
			, #{postNo,jdbcType=NUMERIC}
			, #{memberNo,jdbcType=NUMERIC}
			, 'Y'
		)
	</insert>

	<!-- 좋아요 등록 및 취소 (POST 테이블 UPDATE)-->
	<update id="likeUpdate">
		UPDATE
			POST
		SET
			POST_LIKE_COUNT = #{postLikeCount,jdbcType=NUMERIC}
		WHERE
			POST_NO = #{postNo,jdbcType=NUMERIC}
	</update>


	<!-- 좋아요 취소 (LIKE 테이블 DELETE) -->
	<delete id="likeDelete">
		DELETE FROM
			LIKES
		WHERE
			POST_NO = #{postNo,jdbcType=NUMERIC}
	</delete>

</mapper>