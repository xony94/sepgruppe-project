/** 
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 4. 8.     	SHJ            ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */

if (typeof alarmConnected === 'undefined') {
  var alarmConnected = false;
}
// ğŸ”” Notification ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function showPushNotification(title, content, onClickCallback) {
	
	// ğŸ”” ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then(function (permission) {
            console.log("ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:", permission);
        });
    }
		
    if (Notification.permission === "granted") {
        const notification = new Notification(title, {
            body: content
        });

        // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        notification.onclick = function(event) {
            event.preventDefault();
            if (typeof onClickCallback === "function") {
                onClickCallback();
            }
			notification.close();
        };
    }
}
function connectAlarm(userId) {
	
	if (alarmConnected) return;
	
    const socket = new SockJS("/sep/stomp");
    alarmClient = Stomp.over(socket);

    alarmClient.connect({}, function(frame) {
        console.log("ğŸ”” ì•Œë¦¼ ì—°ê²° ì™„ë£Œ");

        // ì˜ˆ: /topic/alarm/{userId} êµ¬ë…
    alarmClient.subscribe("/topic/alarm/" + userId, function(message) {
        const alarm = JSON.parse(message.body);
		
		// ìê¸° ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì œì™¸í•˜ê³  ì•Œë¦¼ í‘œì‹œ
		if (alarm.senderEmpId !== userId) {
			const senderName = alarm.organization?.empNm || "ì•Œ ìˆ˜ ì—†ìŒ";
			const chatroomId = alarm.roomId; // ë©”ì‹œì§€ì— í¬í•¨ëœ ì±„íŒ…ë°© ID

			showPushNotification("ğŸ“¬ ìƒˆ ë©”ì‹œì§€", senderName + ": " + alarm.msgContent, function() {
				openChatRoom(chatroomId); // ğŸ‘ˆ í´ë¦­ ì‹œ ì´ í•¨ìˆ˜ ì‹¤í–‰
			});
		}
    });
	
	alarmClient.subscribe("/topic/project/" + userId, function(message) {
	    const projectAlarm = JSON.parse(message.body);
	    showPushNotification("ğŸ“‹ ê³µìœ í”„ë¡œì íŠ¸ì— ì°¸ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", projectAlarm.alarmNm, function() {
	        openProjectPage(projectAlarm.alarmCategoryNo);
	    });
	});
	
	alarmClient.subscribe("/topic/task/" + userId, function(message) {
	    const taskAlarm = JSON.parse(message.body);
	    showPushNotification("ğŸ“‹ í”„ë¡œì íŠ¸ì— ì¼ê°ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.", " " ,function() {
	        openTaskPage(taskAlarm.alarmCategoryNo);
	    });
	});
	
	alarmClient.subscribe("/topic/appr/" + userId, function(message) {
	    const apprAlarm = JSON.parse(message.body);
	    showPushNotification("ğŸ“‹ ì „ìê²°ì¬ ê²°ì¬ìš”ì²­.",apprAlarm.aprvlDocTitle , function() {
	        openApprPage(apprAlarm.alarmContent);
	    });
	});
	
    });
}

function openChatRoom(chatroomId) {
    openMessengerWindow(); // 1. ë©”ì‹ ì € ì°½ ì—´ê¸°

	setTimeout(function () {
	        if (sepMessenger.$("#listLink").length) {
	            sepMessenger.$("#listLink")[0].click();
	        }

	        // 3. ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ ë¡œë”© ëŒ€ê¸°
	        waitForRoomToAppear(chatroomId, 0); // roomIdë¥¼ ê°€ì§„ ë°©ì´ ë‚˜ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°
	    }, 300);
}

function openProjectPage(projectId) {
    window.open("/sep/testnum001/project/" + projectId, "_blank");
}

function openTaskPage(taskId) {
    window.open("/sep/testnum001/task/" + taskId, "_blank");
}

function openApprPage(apprId) {
    window.open("/sep/testnum001/apprHome/aprvlDocDetail/" + apprId, "_blank");
}


function waitForRoomToAppear(roomId, tryCount) {
    const targetRoom = sepMessenger.$("li.chat-room-row[data-roomid='" + roomId + "']");

    if (targetRoom.length) {
        console.log("âœ… ë°© ì°¾ìŒ:", roomId);
        targetRoom.trigger("click");
    } else if (tryCount < 20) {
        // ì•„ì§ ë°©ì´ ì•ˆ ëœ¬ ê²½ìš°, 0.3ì´ˆ í›„ ì¬ì‹œë„ (ìµœëŒ€ 20ë²ˆ = ì•½ 6ì´ˆ ëŒ€ê¸°)
        setTimeout(function () {
            waitForRoomToAppear(roomId, tryCount + 1);
        }, 300);
    } else {
        console.warn("â— ì±„íŒ…ë°©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:", roomId);
    }
}

$(document).ready(function () {
    const alarmUserId = $(".main-panel").data("emp-id"); // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
    connectAlarm(alarmUserId); // ì•Œë¦¼ êµ¬ë… ì‹œì‘
});