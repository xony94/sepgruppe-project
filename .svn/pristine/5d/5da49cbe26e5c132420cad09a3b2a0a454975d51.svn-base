/** 
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 3. 21.     	JSW            ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */
function showOrganizationPopup() {
  console.log("âœ… showOrganizationPopup í˜¸ì¶œë¨");
  const popup = document.getElementById('organizationPopup');
  popup.style.display = 'block';
  loadOrganizationTree();
}

function closeOrganizationPopup() {
  console.log("ğŸšª closeOrganizationPopup í˜¸ì¶œë¨");
  document.getElementById('organizationPopup').style.display = 'none';
}

// íŒì—… ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
window.addEventListener('click', function (e) {
  const popup = document.getElementById('organizationPopup');
  if (e.target === popup) {
    closeOrganizationPopup();
  }
});


function loadOrganizationTree() {
  fetch(contextPath + "/" + companyNo + "/organization/parentDep")
    .then(res => res.json())
    .then(data => {
      const organizationTree = document.getElementById('organizationTree');
      organizationTree.innerHTML = '';
      const tree = document.createElement('ul');
      data.forEach(dept => {
        const node = createDepartmentNode(dept, companyNo);
        tree.appendChild(node);
      });
      organizationTree.appendChild(tree);
    });
}

function createDepartmentNode(dept, companyNo) {
  const li = document.createElement('li');
  li.textContent = dept.title; // DepartmentNodeì˜ title

  li.addEventListener('click', function (e) {
    e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€

    // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ í† ê¸€
    if (li.querySelector('ul')) {
      li.removeChild(li.querySelector('ul'));
      return;
    }

    // í•˜ìœ„ ë¶€ì„œì™€ ì§ì› ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(contextPath + "/" + companyNo + `/organization/childeDep?mode=dept&parent=${dept.key}`)
      .then(res => res.json())
      .then(children => {
        const ul = document.createElement('ul');

        // í•˜ìœ„ ë¶€ì„œ
        children.forEach(child => {
          ul.appendChild(createDepartmentNode(child, companyNo));
        });

        // ë¶€ì„œ ë‚´ ì§ì›
        fetch(contextPath + "/" + companyNo +`/organization/childeDep?mode=employee&parent=${dept.key}`)
          .then(res => res.json())
          .then(employees => {
            employees.forEach(emp => {
              const empLi = document.createElement('li');
              empLi.textContent = emp.title; // EmployeeNodeì˜ title
              ul.appendChild(empLi);
            });
          });

        li.appendChild(ul);
      });
  });

  return li;
}