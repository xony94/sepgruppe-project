let path;
const newDocBtn = document.querySelector("#newDocBtn");

document.addEventListener("DOMContentLoaded", () => {
    // ë°ì´í„° ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
    path = document.body.getAttribute('data-context-path');
    console.log(path);

    // fancyTree ì´ˆê¸°í™” (tree ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
    if (document.querySelector('#tree')) {
        initFancyTree();
    }

    // ìƒˆ ì–‘ì‹ ë“±ë¡ ë²„íŠ¼ ì²˜ë¦¬ (newDocBtnì´ ìˆì„ ë•Œë§Œ)
    const newDocBtn = document.querySelector('#newDocBtn');
    if (newDocBtn) {
        newDocBtn.addEventListener("click", handleNewDocBtnClick);
    }

    const apprInfoModal = document.querySelector("#apprInfoModal");

	// ** ê²°ì¬ì •ë³´ ëª¨ë‹¬ **
    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ì‹¤í–‰í•  ì´ë²¤íŠ¸ ë“±ë¡
    apprInfoModal.addEventListener("shown.bs.modal", () => {
        // ì²˜ìŒ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§Œ fancyTreeë¥¼ ì´ˆê¸°í™”
        if (!window.fancyTreeInitialized) {
            depInitFancyTree(); // fancytree ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
            window.fancyTreeInitialized = true; // fancyTreeê°€ ì´ˆê¸°í™” ë˜ì—ˆìŒì„ í‘œì‹œ
        }
        depInitDragAndDrop(); // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
    });

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ, ê²°ì¬ ë¼ì¸ ì €ì¥ í•¨ìˆ˜ ì‹¤í–‰
    document.querySelector("#saveButton").addEventListener("click", saveApprLine);
    depInitDragAndDrop(); // í˜ì´ì§€ ë¡œë“œ ì‹œ, ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
});

// FancyTree ì´ˆê¸°í™” í•¨ìˆ˜
function initFancyTree() {
    $("#tree").fancytree({
        source: { url: `${path}/appr/parentFolder`, cache: false },
        lazyLoad: handleLazyLoad,
        activate: handleNodeActivate,
        beforeSelect: preventFolderSelect
    });
}

// Lazy Load í•¸ë“¤ëŸ¬ (í´ë” ë°ì´í„° ë¡œë“œ)
function handleLazyLoad(event, data) {
    const node = data.node;
    let mode = node.data.parentDocFolder ? "document" : "folder";
    data.result = { url: `${path}/appr/childrenFolder`, data: { mode: mode, parent: node.key }, cache: false };
}

// ë…¸ë“œ í™œì„±í™” í•¸ë“¤ëŸ¬
function handleNodeActivate(event, data) {
    const node = data.node;
    if (node.isFolder()) {
        loadFolderDocuments(node.key);
    } else {
        loadDocumentDetail(node.key);
    }
}

// í´ë” ì„ íƒ ë°©ì§€
function preventFolderSelect(event, data) {
    if (data.node.isFolder()) return false;
}

// í´ë” ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ (AJAX ìš”ì²­)
function loadFolderDocuments(docFolderNo) {
    $.ajax({
        url: `${path}/approval/admin/folderDoc`,
        type: 'GET',
        data: { docFolderNo: docFolderNo },
        success: updateDocumentTable,
        error: () => alert('ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    });
}

// ë¬¸ì„œ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (AJAX ìš”ì²­)
function loadDocumentDetail(docFrmNo) {
    $.ajax({
        url: `${path}/approval/detail`,
        type: 'GET',
        data: { docFrmNo: docFrmNo },
        success: (response) => {
            if (response && response.docFrmContent) {
                document.querySelector('#templateDetails').innerHTML = response.docFrmContent;
                initializeCKEditor();
            } else {
                alert('ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        error: () => alert('ì„œë²„ì™€ì˜ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    });
}

// CKEditor ì´ˆê¸°í™” í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
function initializeCKEditor(callback) {
    document.querySelectorAll("#editor").forEach((editorElement) => {
        if (!editorElement.classList.contains("ckeditor-initialized")) {
            CKEDITOR.replace(editorElement, { versionCheck: false, height: '100%', width: '100%' });
            editorElement.classList.add("ckeditor-initialized");
        }
    });

    // CKEditor ì´ˆê¸°í™” í›„ callback ì‹¤í–‰
    if (callback) callback();
}

// ë¬¸ì„œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (admin)
function updateDocumentTable(documents) {
    const tableBody = document.querySelector("#docTableTbody");
    tableBody.innerHTML = "";
    if (documents.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='2'>ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
    }

    documents.forEach(doc => {
        const row = document.createElement("tr");
        row.id = doc.docFrmNo;
        row.dataset.name = doc.docFrmName;
        row.dataset.content = doc.docFrmContent;
        row.dataset.enabled = doc.isEnabled;
        
        row.innerHTML = `
            <td>${doc.docFrmName}</td>
            <td>${doc.isEnabled}</td>
        `;
        row.style.cursor = "pointer"; // ğŸ¯ ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½
    
        tableBody.appendChild(row);
        row.addEventListener("click", handleRowClick); // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    });
}

function handleRowClick(event) {
    const row = event.currentTarget;  // í´ë¦­í•œ í–‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    console.log("row", row);
    console.log("row.dataset", row.dataset);
    console.log(row.dataset.name);

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const docFrmName = row.dataset.name;  // ë¬¸ì„œ ì œëª©
    const editorContent = row.dataset.content;  // ë¬¸ì„œ ë‚´ìš© (CKEditorìš©)
    const isEnabled = row.dataset.enabled === 'Y';  // í™œì„±í™” ì—¬ë¶€ (boolean)

    // 2. ì–‘ì‹ì— ë°ì´í„° ì±„ìš°ê¸°
    setModalContent(docFrmName, isEnabled);  // ì œëª©ê³¼ í™œì„±í™” ì—¬ë¶€ ì„¤ì •

    // 3. CKEditorì— ë‚´ìš© ì‚½ì…
    const editorInstance = CKEDITOR.instances['editor'];  // CKEditor ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    if (editorInstance) {
        editorInstance.setData(editorContent);  // ì´ë¯¸ CKEditorê°€ ì´ˆê¸°í™”ë˜ì–´ ìˆìœ¼ë©´ ë‚´ìš© ì‚½ì…
    } else {
        // CKEditorê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ì´ˆê¸°í™” í›„ ë‚´ìš© ì‚½ì…
        initializeCKEditor(() => {
            const editorInstance = CKEDITOR.instances['editor'];
            if (editorInstance) {
                editorInstance.setData(editorContent);  // CKEditorì— ë‚´ìš© ì‚½ì…
            }
        });
    }

    // 4. ëª¨ë‹¬ ë„ìš°ê¸°
    openModal();  // ëª¨ë‹¬ì„ ë„ì›ë‹ˆë‹¤.
}

function setModalContent(docFrmName, isEnabled) {
    // ì–‘ì‹ì— ë°ì´í„°ë¥¼ ì±„ì›ë‹ˆë‹¤.
    document.querySelector("#docFrmName").value = docFrmName;  // ì œëª© ì„¤ì •
    document.querySelector("#isEnabled").checked = isEnabled;  // í™œì„±í™” ì—¬ë¶€ ì„¤ì •
}

function openModal() {
    // ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const modalElement = document.querySelector("#docDetailModal");
    if (modalElement) {
        // Bootstrap ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í›„ ë„ìš°ê¸°
        const modal = new bootstrap.Modal(modalElement);
        modal.show();  // ëª¨ë‹¬ ë„ìš°ê¸°
    } else {
        // ëª¨ë‹¬ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥
        console.error("ëª¨ë‹¬ ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

// ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
function previewContent() {
    const editorInstance = CKEDITOR.instances["editor"];
    if (!editorInstance) {
        alert("CKEditorê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }
    const content = editorInstance.getData();
    localStorage.setItem("ckeditor_content", content);
    let newWindow = window.open(`${pageContext.request.contextPath}/${companyNo}/content`, "_blank", "width=800,height=600");
    newWindow.addEventListener("beforeunload", () => {
        localStorage.removeItem("ckeditor_content");
    });
}

// ìƒˆ ì–‘ì‹ ë“±ë¡ (ê´€ë¦¬ì)
function handleNewDocBtnClick(){
	// í˜„ì¬ ì„ íƒëœ í´ë” í™•ì¸
    const selectedNode = $("#tree").fancytree("getActiveNode");
	console.log("selectedNode");

    if (!selectedNode || !selectedNode.isFolder()) {
        alert("ë¬¸ì„œë¥¼ ì¶”ê°€í•  í´ë”ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
    }

    const docFolderNo = selectedNode.key; // ì„ íƒëœ í´ë” ID
    location.href = `${path}/approval/admin/newDocAdd?docFolderNo=${docFolderNo}`;
	
}
