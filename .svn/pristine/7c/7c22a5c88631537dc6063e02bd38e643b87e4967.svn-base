package kr.or.ddit.works.organization.service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import kr.or.ddit.works.mybatis.mappers.OrganizationMapper;
import kr.or.ddit.works.organization.vo.DepartmentVO;
import kr.or.ddit.works.organization.vo.EmployeeVO;

@Service
public class OrganizationServiceImpl implements OrganizationService {
	
	@Autowired
	private OrganizationMapper mapper;
	
	@Override
	public List<DepartmentVO> getAllDepartments(String companyNo) {
		// ëª¨ë“  ë¶€ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	    List<DepartmentVO> allDepartments = mapper.selectAllDepartments(companyNo);

	    // ë¶€ëª¨ ë¶€ì„œë¥¼ keyë¡œ, í•˜ìœ„ ë¶€ì„œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥
	    Map<String, DepartmentVO> departmentMap = new HashMap<>();
	    List<DepartmentVO> topDepartments = new ArrayList<>();

	    // ëª¨ë“  ë¶€ì„œë¥¼ ë§µì— ì €ì¥ (deptCd ê¸°ì¤€)
	    for (DepartmentVO dept : allDepartments) {
	        departmentMap.put(dept.getDeptCd(), dept);
	    }

	    // íŠ¸ë¦¬ êµ¬ì¡° ë§Œë“¤ê¸°
	    for (DepartmentVO dept : allDepartments) {
	        // ğŸš€ ë¶€ì„œë³„ ì‚¬ì› ì •ë³´ ì¶”ê°€
	        List<EmployeeVO> employees = mapper.selectEmployeesByDept(dept.getDeptCd());
	        dept.setEmployee(employees);

	        if (dept.getParentDeptCd() == null || dept.getParentDeptCd().isEmpty()) {
	            topDepartments.add(dept);
	        } else {
	            DepartmentVO parentDept = departmentMap.get(dept.getParentDeptCd());
	            if (parentDept != null) {
	                parentDept.getSubDepartments().add(dept);
	            }
	        }
	    }
	    return topDepartments;
	}
	
	@Override
	public DepartmentVO getDepartment(String deptCd, String companyNo) {
		Map<String, Object> params = new HashMap<>();
        params.put("deptCd", deptCd);
        params.put("companyNo", companyNo);
		return mapper.selectDepartment(params);
	}

	@Override
	public int addDepartment(DepartmentVO department) {
		return mapper.insertDepartment(department);
	}


}
