/**
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 3. 27.     	KMJ            ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */

document.addEventListener("DOMContentLoaded", function () {
    const menuContainer = document.getElementById("myNavbar"); // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
    let activeTr = null; // í˜„ì¬ ì—´ë¦° tr ì €ì¥ ë³€ìˆ˜

    // ğŸ“Œ 1. ë©”ë‰´ ì•„ì´ì½˜(nav-trigger) í´ë¦­ ì‹œ ë©”ë‰´ í‘œì‹œ
    document.querySelectorAll(".nav-trigger").forEach(item => {
        item.addEventListener("click", function (event) {
            event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€

            let trElement = this.closest("tr"); // í´ë¦­í•œ ì•„ì´ì½˜ì˜ tr ì°¾ê¸°
            if (!trElement) {
                console.error("trì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ğŸ”„ ì´ì „ ë©”ë‰´ê°€ ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ê¸°
            if (activeTr && activeTr !== trElement) {
                menuContainer.style.display = "none";
            }

            activeTr = trElement; // í˜„ì¬ ì—´ë¦° tr ì €ì¥

            // ğŸ“Œ ë©”ë‰´ ìœ„ì¹˜ ì¡°ì • (tr ë°”ë¡œ ì•„ë˜ì— í‘œì‹œ)
            let rect = trElement.getBoundingClientRect();
            menuContainer.style.position = "absolute";
            menuContainer.style.top = `${window.scrollY + rect.bottom}px`;
            menuContainer.style.left = `${rect.left}px`;
            menuContainer.style.display = "block";
        });
    });

    // ğŸ“Œ 2. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ fileId ê°€ì ¸ì™€ì„œ ì‹¤í–‰
    document.querySelectorAll(".downloadClick").forEach(item => {
        item.addEventListener("click", function () {
            if (!activeTr) {
                alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            let fileId = activeTr.dataset.fileId;
            if (fileId) {
                console.log("ë‹¤ìš´ë¡œë“œ fileId:", fileId);
                downloadFile(fileId); // ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
            } else {
                console.error("íŒŒì¼ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                alert("íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });

    // ğŸ“Œ 3. ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener("click", function () {
        menuContainer.style.display = "none";
        activeTr = null;
    });

    // ğŸ“Œ 4. ë©”ë‰´ ë‚´ë¶€ í´ë¦­ ì‹œ ë‹«íˆì§€ ì•Šë„ë¡ ì„¤ì •
    menuContainer.addEventListener("click", function (event) {
        event.stopPropagation();
    });

    // ğŸ“Œ 5. íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    let uploadBtn = document.querySelector("#pills-home-tab-icon");
    let fileInput = document.querySelector("#fileInput");
    if (uploadBtn) {
        uploadBtn.addEventListener("click", function () {
            if (fileInput) {
                fileInput.click();
            } else {
                console.error("íŒŒì¼ ì…ë ¥ ìš”ì†Œ(#fileInput)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    } else {
        console.error("íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼(#pills-home-tab-icon)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ğŸ“Œ 6. íŒŒì¼ ì„ íƒ í›„ ì—…ë¡œë“œ ì‹¤í–‰
    if (fileInput) {
        fileInput.addEventListener("change", function () {
            uploadFile();
        });
    }

    // ğŸ“Œ 7. íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
    function uploadFile() {
        let fileInput = document.querySelector("#fileInput");
        if (!fileInput || fileInput.files.length === 0) {
            alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        let file = fileInput.files[0];
        let formData = new FormData();
        formData.append("file", file);
        formData.append("empId", empId); // ë¡œê·¸ì¸ëœ empIdë¥¼ ë™ì ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•¨

        fetch(contextPath + "/" + companyNo + "/webhard/new", {
            method: "POST",
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            alert("ì—…ë¡œë“œ ì„±ê³µ");
            location.reload(); // ì—…ë¡œë“œ í›„ íŒŒì¼ ëª©ë¡ ê°±ì‹ 
        })
        .catch(error => {
            console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // ğŸ“Œ 8. íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
	function downloadFile(fileId) {
	    const downloadUrl = contextPath + "/" + companyNo + "/webhard/download/" + fileId;

	    fetch(downloadUrl)
	        .then(response => {
	            if (!response.ok) {
	                throw new Error("íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
	            }

	            // ğŸ“Œ Content-Disposition í—¤ë”ì—ì„œ íŒŒì¼ ì´ë¦„ ì¶”ì¶œ
	            const contentDisposition = response.headers.get("Content-Disposition");
	            let fileName = "file"; // ê¸°ë³¸ íŒŒì¼ ì´ë¦„
	            if (contentDisposition && contentDisposition.indexOf("filename*") > -1) {
	                const fileNameMatch = /filename\*=UTF-8''([\w\-\.]+)/.exec(contentDisposition);
	                if (fileNameMatch && fileNameMatch.length > 1) {
	                    fileName = decodeURIComponent(fileNameMatch[1]);
	                }
	            }

	            return response.blob().then(blob => ({ blob, fileName }));
	        })
	        .then(({ blob, fileName }) => {
	            // ğŸ“¥ Blob ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
	            const url = window.URL.createObjectURL(blob);
	            const link = document.createElement("a");
	            link.href = url;
	            link.setAttribute("download", fileName);
	            console.log("ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì´ë¦„:", fileName);
	            document.body.appendChild(link);
	            link.click();
	            document.body.removeChild(link);
	        })
	        .catch(error => {
	            console.error("íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
	            alert("íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	        });
	}
	
	// íŒŒì¼ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	let deleteBtn = document.querySelector("#pills-profile-tab-icon");
	if (deleteBtn) {
	    deleteBtn.addEventListener("click", function () {
	        let selectedFile = document.querySelector('input[name="deleteFile"]:checked');
			
			if (!selectedFile) {
		        Swal.fire({
		            icon: "warning",
		            title: "ì²´í¬ í•„ìš”!",
		            text: "ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!",
		            confirmButtonText: "í™•ì¸",
		            confirmButtonColor: "#ff9800",
		        });
		        return;
		    }
			let selectedFileId = selectedFile.value; // ì„ íƒëœ íŒŒì¼ ID ê°€ì ¸ì˜¤ê¸°

	        if (confirm("ì„ íƒí•œ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
	            deleteFile(selectedFileId);
	        }
	    });
	} else {
	    console.error("íŒŒì¼ ì‚­ì œ ë²„íŠ¼(#pills-profile-tab-icon)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	}

	// íŒŒì¼ ì‚­ì œ í•¨ìˆ˜ (AJAX ì‚¬ìš©)
	function deleteFile(fileId) {
	    $.ajax({
	        url: contextPath + "/" + companyNo + "/webhard/delete/" + fileId,
	        type: "DELETE",
			dataType: "JSON",
	        success: function(response) {
	            alert("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
	            location.reload(); // íŒŒì¼ ëª©ë¡ ê°±ì‹ 
	        },
	        error: function(xhr, status, error) {
	            console.error("íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
	            alert("íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	        }
	    });
	}

});
