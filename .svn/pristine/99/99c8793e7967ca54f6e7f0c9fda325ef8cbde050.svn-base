<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.works.mybatis.mappers.ChatMapper">

<!-- 채팅방 저장 -->
<insert id="insertChatRoom">
	INSERT INTO CHAT_ROOM (
	    ROOM_ID
	    , ROOM_NAME
	    , CREATE_EMP_ID
	    , ROOM_CREATE_DATE
	    , ROOM_TYPE
	) VALUES (
	    #{roomId}
	  , #{roomName}
	  , #{createEmpId}
	  , #{roomCreateDate}
	  , #{roomType}
	)
</insert>

<!-- 채팅방 참여자 저장 -->
<insert id="insertChatRoomUser">
	<selectKey keyProperty="userId" resultType="string"
		order="BEFORE">
		SELECT SEQ_CHAT_ROOM_USER.NEXTVAL FROM DUAL
	</selectKey>
	INSERT INTO CHAT_ROOM_USER (
	    USER_ID
	    , ROOM_ID
	    , EMP_ID
	    , JOIN_TIME
	    , ROLE
	) VALUES (
	    #{userId}
	  , #{roomId}
	  , #{empId}
	  , #{joinTime}
	  , #{role}
	)
</insert>

<!-- 메시지 저장 -->
<insert id="insertMessage">
	INSERT INTO MESSAGE (
	    MSG_ID
	    , ROOM_ID
	    , SENDER_EMP_ID
	    , MSG_CONTENT
	    , SEND_TIME
	) VALUES (
	    #{msgId}
	  , #{roomId}
	  , #{senderEmpId} 
	  , #{msgContent} 
	  , #{sendTime}
	)
</insert>

<resultMap id="rommUserMap" type="ChatRoomUserVO" autoMapping="true">
	<association property="chatRoom" javaType="ChatRoomVO" autoMapping="true"></association>
</resultMap>

<!-- 내 채팅방 목록 -->
<select id="selectListAllChatRoom" resultMap="rommUserMap">
	SELECT
	    USER_ID
	  , ROOM_ID
	  , ROOM_NAME
	  , EMP_ID
	  , JOIN_TIME
	FROM
	    CHAT_ROOM_USER NATURAL JOIN CHAT_ROOM
	WHERE EMP_ID = #{empId}
</select>

<!-- 채팅방 메시지 불러오기 -->
<select id="findAllMessageByRoomId">
	SELECT
	    MSG_ID
	  , ROOM_ID
	  , SENDER_EMP_ID
	  , MSG_CONTENT
	  , SEND_TIME
	FROM
	    MESSAGE
	WHERE ROOM_ID = #{roomId}
	ORDER BY SEND_TIME ASC
</select>

</mapper>
