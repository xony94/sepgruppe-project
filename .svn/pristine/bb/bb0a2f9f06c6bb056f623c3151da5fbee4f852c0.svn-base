package kr.or.ddit.works.project.controller;

import java.security.Principal;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.scheduling.annotation.Schedules;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.ddit.works.alarm.controller.GWAlarmController;
import kr.or.ddit.works.mybatis.mappers.TaskMapper;
import kr.or.ddit.works.project.service.TaskService;
import kr.or.ddit.works.project.vo.ProjectParticipantVO;
import kr.or.ddit.works.project.vo.ProjectVO;
import kr.or.ddit.works.project.vo.TaskVO;
import kr.or.ddit.works.schedule.service.ScheduleService;
import kr.or.ddit.works.schedule.vo.ScheduleVO;
import lombok.extern.slf4j.Slf4j;

/**
 * ê³µìœ  í”„ë¡œì íŠ¸ ì¼ê° ì»¨íŠ¸ë¡¤ëŸ¬
 * @author KKM
 * @since 2025. 3. 25.
 * @see
 *
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 25.     	KKM	          ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */
@Slf4j
@Controller
@RequestMapping("/{companyNo}/task")
public class TaskController {
	
	@Autowired
	private TaskService taskService;
	
	 @Autowired
	 private TaskMapper taskMapper;
	
	 @Autowired
	 private ScheduleService scService; 
	 
	 @Autowired
	 private GWAlarmController gwAlarmController;
	/** ì¼ë°˜ ì‚¬ì› - ëª¨ë“  ì¼ê° ëª©ë¡ */
	 @GetMapping("")
	 public String selectListProjectTask(
		        @PathVariable("companyNo") String companyNo,
		        @RequestParam(required = false) Long projectNo,
		        Model model) {  // Principal ë§¤ê°œë³€ìˆ˜ ì œê±°

		    // ëª¨ë“  ì¼ê° ëª©ë¡ ì¡°íšŒ
		 	List<TaskVO> tasks = taskService.getTasksByProjectNo(projectNo);
		 	model.addAttribute("tasks", tasks);
		 	model.addAttribute("companyNo", companyNo);
		 	model.addAttribute("projectNo", projectNo);

		    // ğŸ”½ í”„ë¡œì íŠ¸ ìƒì„±ì ID ì¡°íšŒ í›„ ì „ë‹¬
		    if (projectNo != null) {
		        ProjectVO project = taskService.getProjectByNo(projectNo);
		        if (project != null) {
		            model.addAttribute("projectEmpId", project.getEmpId()); // ìƒì„±ì ID
		            model.addAttribute("projectTitle", project.getProjectTitle());
		        }
		    }
		 	
		    // ì¼ê° ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
		    return "gw:task/taskList"; 
	    }
	
	 /** íŠ¹ì • ì¼ê° ìƒì„¸ ì¡°íšŒ */
	 @GetMapping("/{taskNo}")
	 public String selectTaskDetail(
	         @PathVariable("companyNo") String companyNo,
	         @PathVariable("taskNo") long taskNo, // íƒ€ì…ì„ longìœ¼ë¡œ ë³€ê²½
	         @RequestParam(value = "projectNo", required = false) Long projectNo,
	         Model model) {
	     // íŠ¹ì • ì¼ê° ìƒì„¸ ì •ë³´ ì¡°íšŒ
	     TaskVO taskDetail = taskService.selectTaskDetail(taskNo); // ì„œë¹„ìŠ¤ì—ì„œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
	     
	     if (taskDetail.getProjectNo() == 0 || taskDetail.getProjectNo() == null) {
	    	    taskDetail.setProjectNo(projectNo);
	     }
	     

	     // ëª¨ë¸ì— ì¼ê° ìƒì„¸ ì •ë³´ ë° íšŒì‚¬ ë²ˆí˜¸ ì¶”ê°€
	     model.addAttribute("taskDetail", taskDetail);
	     model.addAttribute("companyNo", companyNo); // íšŒì‚¬ ë²ˆí˜¸ ì¶”ê°€
	     model.addAttribute("projectNo", projectNo);

	     // ì¼ê° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
	     return "gw:task/taskDetail";
	 }
	 
	 
	 @GetMapping("/new")
	    public String insertTaskFormUI(
	            @PathVariable("companyNo") String companyNo,
	            @RequestParam(value = "projectNo", required = false) Long projectNo,
	            Model model,
	            Principal principal) {

	        String empId = principal.getName();
	        List<ProjectVO> projects = taskService.selectAllProjects(empId);
	        model.addAttribute("projects", projects);
	        model.addAttribute("companyNo", companyNo);

	        if (projectNo != null) {
	            List<ProjectParticipantVO> participants = taskService.selectListAllParticipants(projectNo);
	            ProjectVO project = taskService.getProjectByNo(projectNo); // í”„ë¡œì íŠ¸ ì •ë³´ ì¡°íšŒ

	            model.addAttribute("participants", participants);
	            model.addAttribute("selectedProjectNo", projectNo);
	            model.addAttribute("selectedProjectTitle", project.getProjectTitle());
	        } else {
	            model.addAttribute("participants", null);
	            model.addAttribute("selectedProjectNo", null);
	            model.addAttribute("selectedProjectTitle", null);
	        }
	        return "gw:task/taskForm";
	    }

		@PostMapping("/new")
		public String insertTask(
		        @PathVariable("companyNo") String companyNo,
		        @ModelAttribute TaskVO task,
		        @RequestParam(value = "projectNo", required = false) Long projectNo,
		        @RequestParam("empId") String empId,
		        @RequestParam(value = "uploadFiles", required = false) List<MultipartFile> uploadFiles
		) {
		    if (projectNo != null) {
		        task.setProjectNo(projectNo);
		    }
		    task.setEmpId(empId);
		    task.setUploadFiles(uploadFiles);
//		    ScheduleVO
		    ProjectVO project = taskService.getProjectByNo(projectNo);
		    if (project != null) {
		        task.setProjectEmpId(project.getEmpId());
		    }
		    
		    Long participantNo = taskService.getProjectParticipantNo(projectNo, empId);
		    task.setProjectParticipantNo(participantNo);

		    boolean isInserted = taskService.insertTask(task);
//		    scService.createSchedule();
		    if (isInserted) {
		        long taskNo = taskMapper.getLastInsertedTaskNo();
		        gwAlarmController.sendTaskAlarm(task, empId, taskNo);
		        return "redirect:/" + companyNo + "/task/" + taskNo;
		    } else {
		        return "redirect:/" + companyNo + "/task/new";
		    }
		}

		/** íŠ¹ì • í”„ë¡œì íŠ¸ì˜ ì°¸ì—¬ì ëª©ë¡ ì¡°íšŒ */
		@GetMapping("/new/participants/{projectNo}")
		@ResponseBody
		public List<ProjectParticipantVO> getParticipants(@PathVariable("projectNo") long projectNo) {
		    log.debug("Fetching participants for projectNo: {}", projectNo); // í™•ì¸ìš© ë¡œê·¸
		    List<ProjectParticipantVO> participant = taskService.selectListAllParticipants(projectNo);
		    return participant;
		}
		
		// ì¼ê° ìƒì„¸í˜ì´ì§€ ì•ˆì—ì„œ ì‚­ì œ
		@PostMapping("/{taskNo}/delete")
		public String deleteTaskViaPost(
		        @PathVariable("companyNo") String companyNo,
		        @PathVariable("taskNo") long taskNo,
		        @RequestParam("projectNo") Long projectNo,
		        RedirectAttributes redirectAttributes,
		        Principal principal) {
			
			String loginEmpId = principal.getName();
		    TaskVO task = taskService.selectTaskDetail(taskNo);

		    // ê¶Œí•œ ì²´í¬: ì‚­ì œ ê¶Œí•œì´ ì—†ìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ + ì‹¤íŒ¨ ë©”ì‹œì§€
		    if (!loginEmpId.equals(task.getEmpId()) && !loginEmpId.equals(task.getProjectEmpId())) {
		        redirectAttributes.addFlashAttribute("deleteFail", "ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		        return "redirect:/" + companyNo + "/task?projectNo=" + projectNo;
		    }
			
		    taskService.deleteTask(taskNo);
		    
		    redirectAttributes.addFlashAttribute("deleteSuccess", true);

		    // ì‚­ì œ í›„, í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ì¼ê° ëª©ë¡ìœ¼ë¡œ ì´ë™
		    return "redirect:/" + companyNo + "/task?projectNo=" + projectNo;
		}
		
		// ì¼ê° ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œ 
		@PostMapping("ajax/delete")
		@ResponseBody
		public ResponseEntity<?> deleteTasksAjax(
		        @PathVariable String companyNo,
		        @RequestBody Map<String, Object> payload,
		        Principal principal
		        ) {
			List<String> taskNoStrings = (List<String>) payload.get("taskNos");
			String loginEmpId = principal.getName();

		    if (taskNoStrings == null || taskNoStrings.isEmpty()) {
		        return ResponseEntity.badRequest().body("ì‚­ì œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
		    }

		    List<Long> taskNos = new ArrayList<>();
		    for (String no : taskNoStrings) {
		        try {
		            taskNos.add(Long.parseLong(no));
		        } catch (NumberFormatException e) {
		            return ResponseEntity.badRequest().body("ì˜ëª»ëœ ì¼ê° ë²ˆí˜¸ í˜•ì‹ì…ë‹ˆë‹¤.");
		        }
		    }

		    for (Long taskNo : taskNos) {
		        TaskVO task = taskService.selectTaskDetail(taskNo);
		        if (task == null) continue;

		        // ë‹´ë‹¹ì or í”„ë¡œì íŠ¸ ìƒì„±ìì¸ ê²½ìš°ë§Œ ì‚­ì œ
		        if (loginEmpId.equals(task.getEmpId()) || loginEmpId.equals(task.getProjectEmpId())) {
		            taskService.deleteTask(taskNo);
		        } else {
		            // ì‚­ì œ ê¶Œí•œ ì—†ìŒ â†’ 403 ì‘ë‹µ
		            return ResponseEntity.status(403).body("ì¼ê° ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		        }
		    }

		    return ResponseEntity.ok("ì‚­ì œ ì™„ë£Œ");
		}
		
		// ìˆ˜ì • í¼ ì´ë™
		@GetMapping("/{taskNo}/edit")
		public String editTaskForm(
		        @PathVariable("companyNo") String companyNo,
		        @PathVariable("taskNo") Long taskNo,
		        Model model
		) {
		    TaskVO task = taskService.selectTaskDetail(taskNo);
		    if (task == null) {
		        return "redirect:/" + companyNo + "/task"; // í˜¹ì€ ì—ëŸ¬ í˜ì´ì§€
		    }
		    ProjectVO project = taskService.getProjectByNo(task.getProjectNo());
		    
		    List<ProjectParticipantVO> participants = taskService.selectListAllParticipants(task.getProjectNo());

		    model.addAttribute("task", task);
		    model.addAttribute("companyNo", companyNo);
		    model.addAttribute("mode", "edit");  // JSPì—ì„œ ìˆ˜ì • ëª¨ë“œë¡œ í‘œì‹œ
		    model.addAttribute("selectedProjectNo", task.getProjectNo());
		    model.addAttribute("selectedProjectTitle", project != null ? project.getProjectTitle() : "");
		    model.addAttribute("participants", participants);
		    
		    return "gw:task/taskForm";
		}
		
		@PostMapping("/{taskNo}/edit")
		public String updateTask(
		        @PathVariable("companyNo") String companyNo,
		        @PathVariable("taskNo") long taskNo,
		        @ModelAttribute TaskVO task,
		        RedirectAttributes redirectAttributes,
		        Principal principal
		) {
			task.setTaskNo(taskNo);
			
		    String empId = principal.getName();
		    TaskVO original = taskService.selectTaskDetail(task.getTaskNo());

		    if (!empId.equals(original.getEmpId()) && !empId.equals(original.getProjectEmpId())) {
		        redirectAttributes.addFlashAttribute("error", "ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
		        return "redirect:/" + companyNo + "/task/" + task.getTaskNo();
		    }

		    taskService.updateTask(task);
		    return "redirect:/" + companyNo + "/task/" + task.getTaskNo();
		}

}
