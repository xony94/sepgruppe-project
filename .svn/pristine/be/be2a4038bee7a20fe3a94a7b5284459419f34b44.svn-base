package kr.or.ddit.works.reservation.controller;

import java.security.Principal;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import kr.or.ddit.works.reservation.service.ReservationService;
import kr.or.ddit.works.reservation.vo.MeetingRoomVO;
import kr.or.ddit.works.reservation.vo.ReservationVO;

/**
 * 회의실 컨트롤러
 * @author JYS
 * @since 2025. 3. 15.
 * @see
 *
 * <pre>
 * << 개정이력(Modification Information) >>
 *   
 *   수정일      			수정자           수정내용
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 15.     	JYS	          최초 생성
 *  2025. 3. 17.  		KKM  		  개발 중
 *  2025. 4.  2.     	SJH           수정 중
 *
 * </pre>
 */
/**
 * 회의실 예약 관련 컨트롤러
 * - 예약 목록 조회, 등록, 수정, 삭제 처리
 * - 날짜 기반 시간표 렌더링 및 모달 연동
 */
@Controller
@RequestMapping("/{companyNo}/reservation")
public class ReservationController {

    @Autowired
    private ReservationService reservationService;

    /**
     * 예약 현황 조회 (메인 페이지)			
     */
    @GetMapping
    public String getReservations(@PathVariable("companyNo") String companyNo,
                                  @RequestParam(value = "date", defaultValue = "today") String date,
                                  Principal principal,
                                  Model model) {

        String empId = principal != null ? principal.getName() : null;
        model.addAttribute("empId", empId); // 본인 예약 식별용

        // 날짜 파싱
        LocalDate targetDate = "today".equalsIgnoreCase(date) ? LocalDate.now() : LocalDate.parse(date);
        String currentDate = targetDate.format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        model.addAttribute("currentDate", currentDate);

        // 회의실 및 예약 정보
        List<MeetingRoomVO> allRooms = reservationService.selectListAllRoom();
        List<ReservationVO> reservations = reservationService.selectReservationsByDate(targetDate);

        // 시간표 매핑 (예약된 시간에 예약 객체 매핑)
        Map<Long, Map<String, ReservationVO>> schedule = new LinkedHashMap<>();
        for (MeetingRoomVO room : allRooms) {
            schedule.putIfAbsent(room.getRoomNo(), new LinkedHashMap<>());
        }
        for (ReservationVO r : reservations) {
            long roomNo = r.getRoomNo();
            LocalTime start = r.getReservationStartTime().toLocalTime();
            LocalTime end = r.getReservationEndTime().toLocalTime();
            for (LocalTime t = start; t.isBefore(end); t = t.plusHours(1)) {
                schedule.get(roomNo).put(t.toString().substring(0, 5), r);
            }
        }

        model.addAttribute("schedule", schedule);
        model.addAttribute("allRooms", allRooms);
        model.addAttribute("companyNo", companyNo);

        return "gw:reservation/reservationList";
    }

    /**
     * 예약 상세 조회
     */
    @GetMapping("/{reservationNo}")
    public String selectReservationDetail(@PathVariable("reservationNo") String reservationNo,
                                          @PathVariable("companyNo") String companyNo,
                                          Model model) {
        ReservationVO reservation = reservationService.selectReservationDetail(reservationNo);
        model.addAttribute("reservation", reservation);
        model.addAttribute("companyNo", companyNo);
        return "gw:reservation/reservationDetail";
    }

    /**
     * 예약 등록 처리
     */
    @PostMapping("/new")
    public String insertReservation(@ModelAttribute ReservationVO reservation,
                                    @PathVariable("companyNo") String companyNo,
                                    Authentication authentication
                                    , Model model) {
    	String empId = authentication.getName();
        reservation.setEmpId(empId);
        try {
            if (reservationService.insertReservation(reservation)) {
                // 선택한 날짜로 리다이렉트
                String selectedDate = reservation.getReservationDate().toString();
                return "redirect:/" + companyNo + "/reservation?date=" + selectedDate + "&success=true";
            } else {
                model.addAttribute("error", "예약 등록 실패");
            }
        } catch (Exception e) {
            model.addAttribute("error", "예외 발생: " + e.getMessage());
        }

        return "gw:reservation/reservationList";
    }

    /**
     * 예약 삭제 처리 (본인만 가능)
     */
    @PostMapping("/{reservationNo}/delete")
    public String deleteReservationViaPost(@PathVariable("reservationNo") String reservationNo,
                                           @PathVariable("companyNo") String companyNo) {
        reservationService.deleteReservation(reservationNo);
        return "redirect:/" + companyNo + "/reservation";
    }

}
