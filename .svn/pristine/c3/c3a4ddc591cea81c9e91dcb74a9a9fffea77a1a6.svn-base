/** 
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 19.     	KKM            ìµœì´ˆ ìƒì„±
 *  2025. 4.  2.     	SJH           ìˆ˜ì • ì¤‘
 * </pre>
 */

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'resourceTimeGrid', // Resource Timeline View ì„¤ì •
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        resources: [
            { id: 'a', title: 'íšŒì˜ì‹¤ A' },
            { id: 'b', title: 'íšŒì˜ì‹¤ B' },
            { id: 'c', title: 'íšŒì˜ì‹¤ C' }
        ],
        events: function(fetchInfo, successCallback) {
            $.ajax({
                url: '/${companyNo}/reservation/api/status/' + new Date().toISOString().split('T')[0],
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    const events = data.map(reservation => {
                        return {
                            title: reservation.reservationContent,
                            start: reservation.reservationStartTime,
                            end: reservation.reservationEndTime,
                            resourceId: reservation.roomNo // íšŒì˜ì‹¤ ë²ˆí˜¸ì— ë§ì¶° ë¦¬ì†ŒìŠ¤ ID ì„¤ì •
                        };
                    });
                    successCallback(events);
                },
                error: function() {
                    console.error("Error fetching events");
                }
            });
        },
        slotDuration: '00:30:00',
        resourceAreaHeaderContent: 'íšŒì˜ì‹¤',
        eventClick: function(info) {
            alert('ì˜ˆì•½ ìƒì„¸: ' + info.event.title);
        },
        slotClick: function(info) {
            openReservationModal(info.date); // í´ë¦­í•œ ì‹œê°„ì— ë§ì¶° ëª¨ë‹¬ ì—´ê¸°
        }
    });

    calendar.render();
});

// ì˜ˆì•½ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
function openReservationModalFromCalendar(date) {
	$('#reservationModal').modal('show');
	document.getElementById('reservationStartTime').value = date.toISOString().substring(0, 16); // í´ë¦­í•œ ì‹œê°„ìœ¼ë¡œ ì‹œì‘ ì‹œê°„ ì„¤ì •
	document.getElementById('reservationEndTime').value = date.toISOString().substring(0, 16); // í´ë¦­í•œ ì‹œê°„ìœ¼ë¡œ ì¢…ë£Œ ì‹œê°„ ì„¤ì •
	document.getElementById('roomNo').value = ''; // íšŒì˜ì‹¤ ë²ˆí˜¸ ì´ˆê¸°í™”
	document.getElementById('empId').value = ''; // ì‚¬ì› ID ì´ˆê¸°í™”
}

// í…Œì´ë¸”ì—ì„œ ì˜ˆì•½ í´ë¦­ ì‹œ í˜¸ì¶œ
function openReservationModal(companyNo, roomNo, hour) {
    if (!roomNo || !hour) {
        alert("íšŒì˜ì‹¤ ë²ˆí˜¸ ë˜ëŠ” ì‹œê°„ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    const timeFormatted = (hour < 10 ? "0" : "") + hour + ":00";
    const currentDate = new Date().toISOString().split("T")[0];

    console.log("ğŸ“Œ openReservationModal:", companyNo, roomNo, timeFormatted);

    fetch(`${pageContext.request.contextPath}/${companyNo}/reservation/new?roomNo=${roomNo}&time=${timeFormatted}&date=${currentDate}`)
        .then(response => response.text())
        .then(data => {
            document.getElementById("modalBody").innerHTML = data;
            $('#reservationModal').modal('show');
        })
        .catch(error => console.error('Error:', error));
}
