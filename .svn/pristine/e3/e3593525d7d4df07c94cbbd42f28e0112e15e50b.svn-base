package kr.or.ddit.works.survey.api;

import java.util.ArrayList;
import java.util.List;

import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.springframework.stereotype.Service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import kr.or.ddit.works.survey.vo.SurveyResponseVO;
import kr.or.ddit.works.survey.vo.SurveyVO;

/**
 * 
 * @author SJH
 * @since 2025. 3. 24.
 * @see
 *
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 24.     	SJH	          ìµœì´ˆ ìƒì„±
 *
 * </pre>
 */
@Service
public class SurveyApiServiceImpl implements SurveyApiService {

    private static final String API_BASE = "https://api.surveymonkey.com/v3";
    
    // ğŸ” ì ˆëŒ€ë¡œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì„œë²„ ë‚´ì—ì„œë§Œ ì‚¬ìš©!
    private static final String ACCESS_TOKEN = "LXs5ovMHyr4wSkLSS8XATbigcAhdK2MRdFnrpPtm8HGc0Z7yFQ6pzAMtSeY1swdDNxsOHhfU0xmu7yvo-m5Irkc0s6ZJsoYnhkAc-w22lNM6EcI7mxUD9p0MD-7owmfv";

    @Override
    public String createSurvey(String jsonBody) throws Exception {
        String url = API_BASE + "/surveys";

        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpPost post = new HttpPost(url);
            post.setHeader("Authorization", "Bearer " + ACCESS_TOKEN);
            post.setHeader("Content-Type", "application/json");
            post.setEntity(new StringEntity(jsonBody, "UTF-8"));

            try (CloseableHttpResponse response = client.execute(post)) {
                int status = response.getStatusLine().getStatusCode();
                String responseBody = EntityUtils.toString(response.getEntity(), "UTF-8");

                if (status >= 200 && status < 300) {
                    return responseBody;
                } else {
                    throw new RuntimeException("ì„¤ë¬¸ ìƒì„± API í˜¸ì¶œ ì‹¤íŒ¨: " + status + "\n" + responseBody);
                }
            }
        }
    }

    @Override
    public boolean createSurveyOnApi(SurveyVO surveyVO) {
        // ì¶”í›„ í™•ì¥ìš© - í˜„ì¬ ë¯¸ì‚¬ìš©
        return false;
    }

    @Override
    public SurveyVO getSurveyDetailsFromApi(String surveyId) {
        String url = API_BASE + "/surveys/" + surveyId;

        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpGet get = new HttpGet(url);
            get.setHeader("Authorization", "Bearer " + ACCESS_TOKEN);

            try (CloseableHttpResponse response = client.execute(get)) {
                int status = response.getStatusLine().getStatusCode();
                String responseBody = EntityUtils.toString(response.getEntity(), "UTF-8");

                if (status >= 200 && status < 300) {
                    // âœ… Jacksonì„ ì´ìš©í•´ JSON íŒŒì‹±
                    ObjectMapper objectMapper = new ObjectMapper();
                    JsonNode jsonNode = objectMapper.readTree(responseBody);

                    SurveyVO survey = new SurveyVO();
                    survey.setSurveyId(jsonNode.get("id").asText());
                    survey.setTitle(jsonNode.get("title").asText());

                    // âœ… ìƒì„±ì¼ì´ ì¡´ì¬í•˜ë©´ ì¶”ê°€
                    if (jsonNode.has("date_created")) {
                        survey.setDateCreated(jsonNode.get("date_created").asText());
                    }

                    // âœ… ìƒì„±ì: ìš°ë¦¬ ì‹œìŠ¤í…œì—ì„œ ë”°ë¡œ ì„¸íŒ…í•´ì•¼ í•¨ (ì˜ˆ: ë¡œê·¸ì¸ ì‚¬ìš©ì ID)
                    survey.setCreator("admin");  // ë˜ëŠ” ì„¸ì…˜ì—ì„œ ì¶”ì¶œ

                    return survey;
                } else {
                    throw new RuntimeException("ì„¤ë¬¸ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: " + status + "\n" + responseBody);
                }
            }
        } catch (Exception e) {
            throw new RuntimeException("ì„¤ë¬¸ ìƒì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
        }
    }

    @Override
    public boolean submitSurveyResponseToApi(String surveyId, SurveyResponseVO responseVO) {
        // ì¶”í›„ í™•ì¥ìš© - í˜„ì¬ ë¯¸ì‚¬ìš©
        return false;
    }
    @Override
    public List<SurveyVO> getAllSurveys() {
        String url = API_BASE + "/surveys";

        try (CloseableHttpClient client = HttpClients.createDefault()) {
            HttpGet get = new HttpGet(url);
            get.setHeader("Authorization", "Bearer " + ACCESS_TOKEN);

            try (CloseableHttpResponse response = client.execute(get)) {
                int status = response.getStatusLine().getStatusCode();
                String responseBody = EntityUtils.toString(response.getEntity(), "UTF-8");

                if (status >= 200 && status < 300) {
                    ObjectMapper objectMapper = new ObjectMapper();
                    JsonNode root = objectMapper.readTree(responseBody);
                    JsonNode data = root.get("data");

                    List<SurveyVO> surveyList = new ArrayList<>();
                    for (JsonNode item : data) {
                        SurveyVO survey = new SurveyVO();
                        survey.setSurveyId(item.get("id").asText());
                        survey.setTitle(item.get("title").asText());

                        if (item.has("date_created")) {
                            survey.setDateCreated(item.get("date_created").asText());
                        }

                        survey.setCreator("admin");

                        surveyList.add(survey);
                    }

                    return surveyList;
                } else {
                    throw new RuntimeException("ì„¤ë¬¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: " + status + "\n" + responseBody);
                }
            }
        } catch (Exception e) {
            throw new RuntimeException("ì„¤ë¬¸ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
        }
    }
}
