let path;
const newDocBtn = document.querySelector("#newDocBtn");

document.addEventListener("DOMContentLoaded", () => {
    // ë°ì´í„° ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
    path = document.body.getAttribute('data-context-path');
    console.log(path);

    // fancyTree ì´ˆê¸°í™” (tree ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
    if (document.querySelector('#tree')) {
        initFancyTree();
    }

    // ìƒˆ ì–‘ì‹ ë“±ë¡ ë²„íŠ¼ ì²˜ë¦¬ (newDocBtnì´ ìˆì„ ë•Œë§Œ)
    const newDocBtn = document.querySelector('#newDocBtn');
    if (newDocBtn) {
        newDocBtn.addEventListener("click", handleNewDocBtnClick);
    }

    const apprInfoModal = document.querySelector("#apprInfoModal");
	
	// ** ê²°ì¬ì •ë³´ ëª¨ë‹¬ **
    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ì‹¤í–‰í•  ì´ë²¤íŠ¸ ë“±ë¡
    apprInfoModal.addEventListener("shown.bs.modal", () => {
        // ì²˜ìŒ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§Œ fancyTreeë¥¼ ì´ˆê¸°í™”
        if (!window.fancyTreeInitialized) {
            depInitFancyTree(); // fancytree ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
            window.fancyTreeInitialized = true; // fancyTreeê°€ ì´ˆê¸°í™” ë˜ì—ˆìŒì„ í‘œì‹œ
        }
        depInitDragAndDrop(); // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
    });
	
    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ, ê²°ì¬ ë¼ì¸ ì €ì¥ í•¨ìˆ˜ ì‹¤í–‰
    document.querySelector("#apprLineSaveBtn").addEventListener("click", saveApprLine);
    depInitDragAndDrop(); // í˜ì´ì§€ ë¡œë“œ ì‹œ, ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™”
});

// FancyTree ì´ˆê¸°í™” í•¨ìˆ˜
function initFancyTree() {
    $("#tree").fancytree({
        source: { url: `${path}/appr/parentFolder`, cache: false },
        lazyLoad: handleLazyLoad,
        activate: handleNodeActivate,
        beforeSelect: preventFolderSelect
    });
}

// Lazy Load í•¸ë“¤ëŸ¬ (í´ë” ë°ì´í„° ë¡œë“œ)
function handleLazyLoad(event, data) {
    const node = data.node;
    let mode = node.data.parentDocFolder ? "document" : "folder";
    data.result = { url: `${path}/appr/childrenFolder`, data: { mode: mode, parent: node.key }, cache: false };
}

// ë…¸ë“œ í™œì„±í™” í•¸ë“¤ëŸ¬
function handleNodeActivate(event, data) {
    const node = data.node;
    if (node.isFolder()) {
        loadFolderDocuments(node.key);
    } else {
        loadDocumentDetail(node.key);
    }
}

// í´ë” ì„ íƒ ë°©ì§€
function preventFolderSelect(event, data) {
    if (data.node.isFolder()) return false;
}

// í´ë” ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ (AJAX ìš”ì²­)
function loadFolderDocuments(docFolderNo) {
    $.ajax({
        url: `${path}/approval/admin/folderDoc`,
        type: 'GET',
        data: { docFolderNo: docFolderNo },
        success: updateDocumentTable,
        error: () => alert('ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    });
}

// realUser ì •ë³´ í™”ë©´ ì¶œë ¥
function renderRealUserInfo(realUser, today) {
    if (!realUser) return;

    document.querySelector('#empNm').textContent = realUser.empNm || '';
    document.querySelector('#positionName').textContent = realUser.positionName || '';
	document.querySelector('#today').textContent = today ||''

}

// ê²°ì¬ ì–‘ì‹ ì´ë¦„ ëœë”ë§
function renderDocFrmName(docFrmName){
	console.log("ê²°ì¬ ì–‘ì‹ : ", docFrmName);
	const docFrmNameTd = document.querySelector("#docFrmNameTd");
	
	docFrmNameTd.innerHTML = '';
	
	docFrmNameTd.innerHTML = `${docFrmName}`;
}

function renderApprLineAutoInfo(aprlLineAuto) {
	console.log("ê²°ì¬ì„  ëœë”ë§");
    if (!aprlLineAuto || aprlLineAuto.length === 0) return;
	console.log("ê²°ì¬ì„ : ",aprlLineAuto);
    const tbody = document.querySelector("#apprLineBody");
	if (!tbody) {
	    console.log("apprLineBody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	    return;
	}
    tbody.innerHTML = ''; // ê¸°ì¡´ í–‰ ì‚­ì œ

    const row1 = document.createElement('tr'); // ì§ìœ„
    const row2 = document.createElement('tr'); // ì´ë¦„
    const row3 = document.createElement('tr'); // ê²°ì¬ì¼ì

    row1.innerHTML = '<th rowspan="3">ìŠ¹ì¸</th>';

    aprlLineAuto.forEach(line => {
        const empList = line.employeeList || [];
        const approver = empList[0]; // ì²« ë²ˆì§¸ ê²°ì¬ìë§Œ í‘œì‹œ

        row1.innerHTML += `<td>${line.positionName || ''}</td>`;
        row2.innerHTML += `<td>${approver ? approver.empNm : ''}</td>`;
        row3.innerHTML += `<td></td>`; // ê²°ì¬ì¼ìëŠ” ì¶”í›„ ì‚½ì…
    });

    tbody.appendChild(row1);
    tbody.appendChild(row2);
    tbody.appendChild(row3);
}

// ë¬¸ì„œ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (AJAX ìš”ì²­)
function loadDocumentDetail(docFrmNo) {
    $.ajax({
        url: `${path}/approval/detail`,
        type: 'GET',
        data: { docFrmNo: docFrmNo },
        success: (response) => {
			console.log("ì‘ë‹µ: ", response)
            if (response && response.docFrmContent) {
				renderDocFrmName(response.docFrmName);
				
				renderRealUserInfo(response.realUser, response.today);
				
				renderApprLineAutoInfo(response.aprlLineAuto);
				
                document.querySelector('#templateDetails').innerHTML = response.docFrmContent;
                initializeCKEditor();
				
            } else {
                alert('ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        error: () => alert('ì„œë²„ì™€ì˜ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    });
}

// CKEditor ì´ˆê¸°í™” í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
function initializeCKEditor(callback) {
    document.querySelectorAll("#editor").forEach((editorElement) => {
        if (!editorElement.classList.contains("ckeditor-initialized")) {
            CKEDITOR.replace(editorElement, { versionCheck: false, height: '100%', width: '100%' });
            editorElement.classList.add("ckeditor-initialized");
        }
    });

    // CKEditor ì´ˆê¸°í™” í›„ callback ì‹¤í–‰
    if (callback) callback();
}

function draftDoc(){
	// 1. CKEditor ê°’ ë°˜ì˜
  	const ckData = CKEDITOR.instances.editor.getData();
  	document.querySelector("#editor").innerHTML = ckData;

  	// 2. ëª¨ë“  input, textarea ê°’ ë°˜ì˜ (ìˆ˜ë™ìœ¼ë¡œ)
  	const draftDocDiv = document.querySelector("#draftDocDiv").cloneNode(true);

  	// input, textarea ë“±ì˜ ê°’ì„ value -> value attributeë¡œ ë³µì‚¬
  	draftDocDiv.querySelectorAll("input, textarea, select").forEach(el => {
   		if (el.tagName === "TEXTAREA") {
      		el.innerHTML = el.value;
    	} else {
      		el.setAttribute("value", el.value);
    	}
  	});

  	// 3. ì™„ì„±ëœ HTML ì¶”ì¶œ
  	const finalHtml = draftDocDiv.innerHTML;
	console.log("ê¸°ì•ˆë¬¸ì„œ ë‚´ìš©: ",finalHtml)
	
}





// ë¬¸ì„œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (admin)
function updateDocumentTable(documents) {
    const tableBody = document.querySelector("#docTableTbody");
    tableBody.innerHTML = "";
    if (documents.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='2'>ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
    }

    documents.forEach(doc => {
        const row = document.createElement("tr");
        row.id = doc.docFrmNo;
        row.dataset.name = doc.docFrmName;
        row.dataset.content = doc.docFrmContent;
        row.dataset.enabled = doc.isEnabled;
        
        row.innerHTML = `
            <td>${doc.docFrmName}</td>
            <td>${doc.isEnabled}</td>
        `;
        row.style.cursor = "pointer"; // ğŸ¯ ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½
    
        tableBody.appendChild(row);
        row.addEventListener("click", handleRowClick); // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    });
}

// ê²°ì¬ ì–‘ì‹ ìˆ˜ì • ëª¨ë‹¬ - ê´€ë¦¬ì
function handleRowClick(event) {
    const row = event.currentTarget;  // í´ë¦­í•œ í–‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    console.log("row", row);
    console.log("row.dataset", row.dataset);
    console.log(row.dataset.name);

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	const docFrmNo = row.id;
    const docFrmName = row.dataset.name;  // ë¬¸ì„œ ì œëª©
    const editorContent = row.dataset.content;  // ë¬¸ì„œ ë‚´ìš© (CKEditorìš©)
    const isEnabled = row.dataset.enabled === 'Y';  // í™œì„±í™” ì—¬ë¶€ (boolean)

    // 2. ì–‘ì‹ì— ë°ì´í„° ì±„ìš°ê¸°
    setModalContent(docFrmNo, docFrmName, isEnabled);  // ì œëª©ê³¼ í™œì„±í™” ì—¬ë¶€ ì„¤ì •

    // 3. CKEditorì— ë‚´ìš© ì‚½ì…
    const editorInstance = CKEDITOR.instances['editor'];  // CKEditor ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    if (editorInstance) {
        editorInstance.setData(editorContent);  // ì´ë¯¸ CKEditorê°€ ì´ˆê¸°í™”ë˜ì–´ ìˆìœ¼ë©´ ë‚´ìš© ì‚½ì…
    } else {
        // CKEditorê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ì´ˆê¸°í™” í›„ ë‚´ìš© ì‚½ì…
        initializeCKEditor(() => {
            const editorInstance = CKEDITOR.instances['editor'];
            if (editorInstance) {
                editorInstance.setData(editorContent);  // CKEditorì— ë‚´ìš© ì‚½ì…
            }
        });
    }

    // 4. ë¬¸ì„œ ìƒì„¸ ëª¨ë‹¬ ë„ìš°ê¸°
    docDetailModalOpen();  // ëª¨ë‹¬ì„ ë„ì›ë‹ˆë‹¤.
}

function setModalContent(docFrmNo, docFrmName, isEnabled) {
    // ì–‘ì‹ì— ë°ì´í„°ë¥¼ ì±„ì›ë‹ˆë‹¤.
	const docFrmNoElement = document.querySelector("td[data-docFrmNo]");  // 'data-docFrmNo' ì†ì„±ìœ¼ë¡œ ê°’ ì„¤ì •
	    if (docFrmNoElement) {
	        docFrmNoElement.setAttribute("data-docFrmNo", docFrmNo);  // 'data-docFrmNo' ì†ì„±ì— ê°’ ì„¤ì •
	    }
    document.querySelector("#docFrmName").value = docFrmName;  // ì œëª© ì„¤ì •
    document.querySelector("#isEnabled").checked = isEnabled;  // í™œì„±í™” ì—¬ë¶€ ì„¤ì •
}

function docDetailModalOpen() {
    // ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const modalElement = document.querySelector("#docDetailModal");
    if (modalElement) {
        // Bootstrap ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í›„ ë„ìš°ê¸°
        const modal = new bootstrap.Modal(modalElement);
        modal.show();  // ëª¨ë‹¬ ë„ìš°ê¸°
    } else {
        // ëª¨ë‹¬ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥
        console.error("ëª¨ë‹¬ ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
	
	const docDetailUpdateBtn = document.querySelector("#docDetailUpdateBtn");
	
	if(docDetailUpdateBtn){
		docDetailUpdate(docDetailUpdateBtn);
	}
	
}

// ìˆ˜ì • ì–‘ì‹ì— ì…ë ¥ëœ ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì²˜ë¦¬(axios)
function docDetailUpdate(docDetailUpdateBtn) {
    docDetailUpdateBtn.addEventListener("click", () => {
        // ì…ë ¥ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
		const docFrmNo = document.querySelector("td[data-docFrmNo]").getAttribute("data-docFrmNo");  // data-docFrmNoì—ì„œ ì–‘ì‹ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        const docFrmName = document.querySelector("#docFrmName").value;  // ì–‘ì‹ëª…
        const docFrmContent = CKEDITOR.instances['editor'] ? CKEDITOR.instances['editor'].getData() : '';  // CKEditor ë‚´ìš©
        const isEnabled = document.querySelector("#isEnabled").checked ? 'Y' : null;  // í™œì„±í™” ì—¬ë¶€ (Y ë˜ëŠ” null)

        // ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„° ê°ì²´ ìƒì„±
        const data = {
            docFrmNo: docFrmNo,
            docFrmName: docFrmName,
            docFrmContent: docFrmContent,
            isEnabled: isEnabled
        };

        // axiosë¡œ ë¹„ë™ê¸° ìš”ì²­ (POST ë°©ì‹ìœ¼ë¡œ ì„œë²„ì— ë°ì´í„° ì „ì†¡)
        axios.post(`${path}/approval/admin/updateDoc`, data)
            .then(response => {
                // ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ê²½ìš°
                if (response.data.success) {
                    alert('ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ëª¨ë‹¬ ë‹«ê¸° ë˜ëŠ” ë‹¤ë¥¸ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
                    closedocDetailModal();
                } else {
                    alert('ë¬¸ì„œ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                // ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
                console.error('ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('ì„œë²„ì™€ì˜ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    });
}

// ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ ì˜ˆì‹œ (ëª¨ë‹¬ ë‹«ì„ ë•Œ)
function closedocDetailModal() {
    const docDetailCloseBtn = document.querySelector("#docDetailCloseBtn");
    if (docDetailCloseBtn) {
        const modal = bootstrap.Modal.getInstance(docDetailCloseBtn);
        modal.hide();  // ëª¨ë‹¬ ë‹«ê¸°
    }
}



// ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
function previewContent() {
	// 1. CKEditorì—ì„œ ë°ì´í„° ë¨¼ì € ê°€ì ¸ì™€
	  const ckData = CKEDITOR.instances.editor.getData();

	  // 2. ì–‘ì‹ í´ë¡ 
	  const templateClone = document.querySelector("#draftDocDiv").cloneNode(true);

	  // 3. CKEditorì˜ ì›ë˜ textarea ìœ„ì¹˜ ì°¾ê¸°
	    const editorTextarea = templateClone.querySelector("#editor");
		templateClone.querySelectorAll("[id^='cke_'], .cke, .cke_reset, .cke_chrome").forEach(el => el.remove());

	    if (editorTextarea) {
	      // 4. ì—ë””í„° UIë¥¼ ê°ì‹¸ê³  ìˆëŠ” ë¶€ëª¨ (.cke_ ë¡œ ì‹œì‘í•˜ëŠ” div) ì œê±°
	      let ckeWrapper = editorTextarea.closest('[class^="cke_"], [id^="cke_"]');
	      if (ckeWrapper) {
	        // wrapperë¥¼ divë¡œ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ckDataë§Œ ë„£ì–´ì¤Œ
	        const contentDiv = document.createElement("div");
	        contentDiv.innerHTML = ckData;

	        // ì›ë˜ wrapper ìë¦¬ì— ë³¸ë¬¸ë§Œ ì‚½ì…
	        ckeWrapper.parentNode.replaceChild(contentDiv, ckeWrapper);
	      } else {
	        // fallback: wrapper ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ textareaì— ë‚´ìš© ë„£ì–´ì¤Œ
	        editorTextarea.outerHTML = `<div>${ckData}</div>`;
	      }
	    }

	  // 6. input, textarea, select ê°’ ë³µì‚¬
	  templateClone.querySelectorAll("input, textarea, select").forEach(el => {
	    if (el.tagName === "TEXTAREA") {
	      el.innerHTML = el.value;
	    } else {
	      el.setAttribute("value", el.value);
	    }
	  });

	  // 7. ì™„ì„±ëœ HTML ë¯¸ë¦¬ë³´ê¸°ìš© ì €ì¥
	  const finalHtml = templateClone.innerHTML;
	  localStorage.setItem("ckeditor_content", finalHtml);
	  const newWindow = window.open(`${path}/content`, "_blank", "width=800,height=600");
	  newWindow.addEventListener("beforeunload", () => {
	    localStorage.removeItem("ckeditor_content");
	  });
}

// ìƒˆ ì–‘ì‹ ë“±ë¡ (ê´€ë¦¬ì)
function handleNewDocBtnClick(){
	// í˜„ì¬ ì„ íƒëœ í´ë” í™•ì¸
    const selectedNode = $("#tree").fancytree("getActiveNode");
	console.log("selectedNode");

    if (!selectedNode || !selectedNode.isFolder()) {
        alert("ë¬¸ì„œë¥¼ ì¶”ê°€í•  í´ë”ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
    }

    const docFolderNo = selectedNode.key; // ì„ íƒëœ í´ë” ID
    location.href = `${path}/approval/admin/newDocAdd?docFolderNo=${docFolderNo}`;
	
}
