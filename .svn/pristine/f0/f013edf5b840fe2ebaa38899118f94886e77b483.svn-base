document.addEventListener('DOMContentLoaded', function() {

    // ì¢Œì¸¡ ê°€ì…ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ í´ë¦­ ì‹œ ì˜¤ë¥¸ìª½ ë‚´ìš© ë™ì ìœ¼ë¡œ ë³€ê²½ (AJAXë¥¼ í†µí•´ ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
	const card = document.querySelector('#card'); // ì²˜ìŒ í™”ë©´ì—ì„œë§Œ ë³´ì´ê³  ë‚˜ë¨¸ì§€ëŠ” ë‹¤ ì•ˆë³´ì—¬ì•¼í•¨
    const content = document.querySelector('.content'); // ëª¨ë“  ì˜¤ë¥¸ìª½ ìš”ì†Œë“¤ì´ ê·¸ë ¤ì ¸ì•¼í•  ê³³

    let currentCommunityNo = null; // ì»¤ë®¤ë‹ˆí‹°ë²ˆí˜¸ ì—¬ëŸ¬ê³³ì—ì„œ ì‚¬ìš©ì„ ìœ„í•œ ì „ì—­ë³€ìˆ˜
    let noPosts = true;            // ê²Œì‹œê¸€ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì¶œë ¥í•˜ê¸° ìœ„í•œ ì „ì—­ë³€ìˆ˜
	let currentPostNo = null;
	let currentMemberNo = null;

	// ë°© ê´€ë¦¬ì—ì„œ íšŒì›ê´€ë¦¬ë¥¼ ìœ„í•œ input ì „ì—­ ë³€ìˆ˜
	let userStatusInput, communityNoInput, empIdInput, memberRoleInput, memberActivityStatusInput, requestNoInput, memberNoInput;


    // ì»¤ë®¤ë‹ˆí‹° í† ê¸€ ì´ë²¤íŠ¸
    function toggleCommunityList() {
        const toggleIcon = document.querySelector('#toggle-communities');
        const communityList = document.querySelector('#community-list');

        toggleIcon.addEventListener('click', function() {
            if (communityList.style.display === 'none' || communityList.style.display === '') {
                communityList.style.display = 'block';
                toggleIcon.classList.remove("bi-chevron-down");
                toggleIcon.classList.add("bi-chevron-up");
            } else {
                communityList.style.display = 'none';
                toggleIcon.classList.remove("bi-chevron-up");
                toggleIcon.classList.add("bi-chevron-down");
            }
        });
    }

    // ì¢Œì¸¡ ê°€ì… ì»¤ë®¤ë‹ˆí‹° í† ê¸€ ì´ë²¤íŠ¸
    toggleCommunityList();

	// ì²« í™”ë©´ íƒ­ ì´ë™ ì´ë²¤íŠ¸ í˜¸ì¶œ
	bindCustomTabEvents();

    // ê°€ì…ì»¤ë®¤ë‹ˆí‹°, ì „ì²´ì»¤ë®¤ë‹ˆí‹° íƒ­ í´ë¦­ ì‹œ ì½˜í…ì¸  ì „í™˜
	function bindCustomTabEvents() {
    const tabs = document.querySelectorAll('.nav-link');
    const tabContents = document.querySelectorAll('.tab-pane');

    tabs.forEach(function(tab) {
        tab.addEventListener('click', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            const targetContent = document.querySelector(`${targetId}`);

            tabContents.forEach(function(content) {
                content.classList.remove('show', 'active');
            });
            targetContent.classList.add('show', 'active');

            tabs.forEach(function(t) {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
        });
    });
}

    // ì¢Œì¸¡ ê°€ì…ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ í´ë¦­ ì‹œ ì¢Œì¸¡ ë‚´ìš© ë™ì ìœ¼ë¡œ ë³€ê²½
    const communityItems = document.querySelectorAll('.community-item');
    const communityLeft = document.querySelector('#community-left');

    communityItems.forEach(function(item) {
        item.addEventListener('click', function() {
            const communityNo = this.getAttribute('data-community-no');
            currentCommunityNo = communityNo;
            loadCommunityDetails(communityNo); // ì•„ë˜ ì´ë²¤íŠ¸ í˜¸ì¶œ
        });
    });

    // ì¢Œì¸¡ ê°€ì…ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ í´ë¦­ ì‹œ ì¢Œì¸¡ ë‚´ìš© ë™ì ìœ¼ë¡œ ë³€ê²½ (AJAXë¥¼ í†µí•´ ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
    function loadCommunityDetails(communityNo) {
        // communityLeft.innerHTML = '';
		card.innerHTML = '';
		// articlesList.innerHTML = '';
        const communityContent = `
            <div class="community-header">
                <i class="bi bi-door-open"></i>
                <span id="communityName"></span>
            </div>

            <a class="btn btn-secondary btn-sm w-100" id="addBoard">
                <i class="bi bi-plus-circle"></i> ê²Œì‹œíŒ ì¶”ê°€
            </a>

            <ul class="list-unstyled">
                <li class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-weight: 500;">ê²Œì‹œíŒëª©ë¡</h6>
                    <i class="bi bi-chevron-down toggle-communities" id="toggle-communities"></i>
                </li>
                <ul class="community-list" id="community-list" style="display: block; list-style-type: none; padding-left: 0;"></ul>
            </ul>

            <ul class="list-unstyled" style="margin-top: 30px;">
                <li class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-weight: 500;">ê°€ì… ë©¤ë²„</h6>
                </li>
                <ul class="member-list list-unstyled" id="member-list" style="display: block; list-style-type: none; padding-left: 0;"></ul>
            </ul>

            <div id="button-container">
                <button class="btn" id="invite-btn">
                    <i class="fas fa-user-plus fa-1x"></i> ì´ˆëŒ€
                </button>

                <button class="btn" id="leave-btn">
                    <i class="fas fa-user-minus fa-1x"></i> íƒˆí‡´
                </button>
            </div>
        `;

        communityLeft.innerHTML = communityContent;
		history.pushState({ page: "communityDetails", communityNo: communityNo }, "Community Details", `#community-${communityNo}`);


        // ê°€ì… ë©¤ë²„ í•˜ë‹¨ì— ê°€ì…ëœ ë©¤ë²„ ëª©ë¡ ì¶œë ¥
        $.ajax({
            url: '/sep/${companyNo}/community/getMembers',
            data: { communityNo: communityNo },
            success: function(data) {
                const memberList = document.querySelector('#member-list');
                memberList.innerHTML = '';

                // ë“±ë¡ëœ ê²Œì‹œíŒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                data.board.forEach(function(boards) {
                    const communityName = document.querySelector('#communityName');
                    communityName.innerHTML = `${boards.communityNm}`;
                    const boardDiv = document.querySelector('#community-list');

                    if (boards.board.length === 0) {
                        boardDiv.innerHTML = `<li class="community-item boardNoPost">ë“±ë¡ëœ ê²Œì‹œíŒì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
                    } else {
                        boards.board.forEach(function(boardList) {
                            boardDiv.innerHTML += `<li class="community-item boardNoPost" data-board-no="${boardList.boardNo}">${boardList.boardNm}</li>`;
                        });
                    }
                });

                // ê°€ì…ëœ ë©¤ë²„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const ownerList = [];
                const memberListArray = [];

                data.members.forEach(function(member) {
                    member.communityMember.forEach(function(communityMemberItem) {
                        const listItem = document.createElement('li');
                        listItem.classList.add('member-item');
                        listItem.style.display = 'flex';
                        listItem.style.marginTop = '10px';

                        const icon = document.createElement('i');
                        icon.classList.add('fas');
                        if (communityMemberItem.memberRole === 'ë°© ì£¼ì¸') {
                            icon.classList.add('fa-crown');
                            icon.style.color = 'rgb(240, 169, 46)';
                            ownerList.push(listItem);
                        } else {
                            icon.classList.add('fa-user');
                            icon.style.setProperty('marginRight', '12px', 'important');
                            icon.style.marginLeft = '3px';
                            icon.style.marginRight = '12px';
                            icon.style.color = 'rgb(46, 120, 240)';
                            memberListArray.push(listItem);
                        }
                        icon.style.fontSize = '1.5rem';
                        icon.style.marginRight = '10px';

                        const nameText = document.createTextNode(communityMemberItem.employee.empNm);
                        listItem.appendChild(icon);
                        listItem.appendChild(nameText);

                        if (communityMemberItem.memberRole === 'ë°© ì£¼ì¸') {
                            ownerList.push(listItem);
                        } else {
                            memberListArray.push(listItem);
                        }
                    });
                });

                ownerList.forEach(function(item) {
                    memberList.appendChild(item);
                });

                memberListArray.forEach(function(item) {
                    memberList.appendChild(item);
                });

                // ì¢Œì¸¡ ê²Œì‹œíŒ ëª©ë¡ í† ê¸€ ì´ë²¤íŠ¸
                toggleCommunityList();

                // ì¢Œì¸¡ ê²Œì‹œíŒ ëª©ë¡ í´ë¦­ ì‹œ ì˜¤ë¥¸ìª½ ë‚´ìš© ë™ì ìœ¼ë¡œ ë³€ê²½
                const boardNoPost = document.querySelectorAll('.boardNoPost');
                boardNoPost.forEach(function(item) {
                    item.addEventListener('click', function() {
                        const boardNo = this.getAttribute('data-board-no');
                        boardNumberPostList(boardNo); // ì•„ë˜ ì´ë²¤íŠ¸ í˜¸ì¶œ
                    });
                });

                function boardNumberPostList(boardNo, skipPush) {
					card.innerHTML = '';

                    let cnt = 0;

                    const tableHeader = `
					<div class="d-flex justify-content-end mb-2">
					    <button class="btn btn-sm btn-primary" id="writePostBtn">
					        <i class="bi bi-pencil-square me-1"></i> ê²Œì‹œê¸€ ì‘ì„±
					    </button>
					</div>
                        <div class="table-responsive">
                            <table id="add-row" class="table table-hover display">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all" /></th>
                                        <th>ê¸€ë²ˆí˜¸</th>
                                        <th>ì œëª©</th>
                                        <th>ì‘ì„±ì</th>
                                        <th>ì‘ì„±ì¼</th>
                                        <th>ì¡°íšŒìˆ˜</th>
                                        <th>ì¢‹ì•„ìš”</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    `;

					const writeForm = `
					    <div class="card p-3">
					        <form id="postForm" enctype="multipart/form-data">
					            <div class="mb-3">
					                <input type="text" name="postTitle" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
					            </div>
					            <div class="mb-3">
					                <textarea id="editor" name="postContent" class="form-control" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
					            </div>
					            <div class="mb-3">
					                <input type="file" name="file" class="form-control" multiple>
					            </div>

					            <input type="text" name="boardNo" id="boardNo">
					            <input type="text" name="memberNo" id="memberNo">

					            <div class="d-flex justify-content-between">
					                <button type="submit" class="btn btn-primary">ì‘ì„±í•˜ê¸°</button>
					            </div>
					        </form>
					    </div>
					`;
					content.innerHTML = tableHeader;

					if (!skipPush) {
					history.pushState({ page: "boardPostList", boardNo: boardNo }, "Board Post List", `#boardPostList/${boardNo}`);
}
                    // ìš°ì¸¡ì— ê²Œì‹œê¸€ ëª©ë¡ ì¶œë ¥
                    $.ajax({
                        url: `/sep/${companyNo}/community/getBoardNoPost`,
                        data: { boardNo: boardNo },
                        success: function(data) {
                            data.boardNoPost.forEach(function(boardNoPosts) {
                                boardNoPosts.board.forEach(function(boards) {

                                    if(boards.post.length === 0){
                                        noPosts = true;
                                    }else{
                                        noPosts = false;
                                        boards.post.forEach(function(boardList) {
                                            const communityContent = `
                                                <tr class="post-item" data-post-no="${boardList.postNo}">
													<input type="hidden" data-member-no="${boardList.memberNo}" value="${boardList.memberNo}">
                                                    <td><input type="checkbox"></td>
                                                    <td>${cnt += 1}</td>
                                                    <td>${boardList.postTitle}</td>
                                                    <td>${boardNoPosts.employee.empNm}</td>
                                                    <td>${boardList.postCreatedAt}</td>
                                                    <td>${boardList.postViewCount}</td>
                                                    <td>${boardList.postLikeCount}</td>
                                                </tr>
                                            `;

                                            tableBody.innerHTML += communityContent;
                                        });
                                    }

                                });
                            });
                            // ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ì„ ê²½ìš° ì¶œë ¥
                            if (noPosts) {
                                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                            }
                        }
                    });

					// ê²Œì‹œê¸€ ì‘ì„±
					const writePostBtn = document.querySelector('#writePostBtn');
					writePostBtn.addEventListener('click',function(){
						console.log("í´ë¦­ ã……ã…‚");

						content.innerHTML = writeForm;

						CKEDITOR.replace('editor', {
						    versionCheck: false,
						    height: 400,
						    width: '100%'
						});

						    setTimeout(() => {
						        const postForm = document.querySelector('#postForm');
								let memberNo = null;

								console.log("data", data);
								data.members.forEach(function(member) {
								    member.communityMember.forEach(function(tlqkf){
								        console.log("tlqkf", tlqkf.memberNo);
								        memberNo = tlqkf.memberNo;
								    });
								});

								// âœ… ì—¬ê¸°ì„œ inputì— ê°’ ë„£ê¸° (memberNo ë‹¤ ëˆ ë’¤ì—)
								postForm.querySelector('#boardNo').value = boardNo;
								postForm.querySelector('#memberNo').value = memberNo;

								console.log("ìµœì¢… memberNo:", memberNo);
						        postForm.addEventListener('submit', function (e) {
						            e.preventDefault(); // í¼ ê¸°ë³¸ ë™ì‘ ë§‰ê¸°

						            const postTitle = postForm.postTitle.value;
						            const postContent = CKEDITOR.instances.editor.getData();
						            //const boardNo = postForm.boardNo.value;
						            //const memberNo = postForm.memberNo.value;

						            const formData = new FormData(postForm);
						            formData.set('postContent', postContent); // ì—ë””í„° ë‚´ìš© ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •

						            $.ajax({
						                url: `/sep/${companyNo}/community/postInsert`,
						                type: 'POST',
						                data: {
											boardNo: boardNo,
											memberNo: memberNo,
											postTitle: postTitle,
											postContent: postContent
										    },

											success: function (data) {
												// ì‘ë‹µìœ¼ë¡œ ë°›ì€ ê²½ë¡œì—ì„œ postNo ì¶”ì¶œ
												const postNo = data.postNo;
												const redirectUrl = data.redirectUrl;

												history.pushState({ page: "postDetail", postNo: postNo, memberNo: memberNo }, "", redirectUrl);

												// ê²Œì‹œê¸€ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸°
												boardPostDetail(postNo, memberNo);
											},
						                error: function (err) {
						                    console.error("ì‘ì„± ì‹¤íŒ¨", err);
						                }
						            });
						        });
						    }, 100); // CKEditor ë¡œë”© ë“± ê³ ë ¤í•´ ì ê¹ ë”œë ˆì´
						});




					// ê²Œì‹œê¸€ ëª©ë¡ í´ë¦­ ì‹œ ìƒì„¸í˜ì´ì§€ ì§„ì…
                    tableBody.addEventListener('click', function(e){
						card.innerHTML = '';

                        const tr = e.target.closest('tr.post-item');
                        const postNo = tr.getAttribute('data-post-no');

						const inputElement = tr.querySelector('input[data-member-no]');
						const memberNo = inputElement.getAttribute('data-member-no');
                        boardPostDetail(postNo, memberNo); // ì•„ë˜ í•¨ìˆ˜ í˜¸ì¶œ
                    });

                    function boardPostDetail(postNo, memberNo){
                        const boardPostPage = `
                            <div class="notice-container">
                                <div class="button-group">
                                    <button type="button" class="btn btn-sm btn-info">Update</button>
                                </div>

                                <div class="notice-info">
                                    <strong name="boardNm"></strong>
                                </div>

                                <div class="notice-title" name="postTitle"></div>

                                <div class="notice-info">
                                    <span name="postEmpNm"></span>

									<div class="icon-view-count">
									    <i class="fas fa-thumbs-up"></i>
									    <span name="postLikeCount" id="postLikeCount"></span>

									    <i class="fas fa-eye"></i>
									    <span name="postViewCount"></span>
									</div>
                                </div>

                                <div class="notice-container">
                                    <i class="bi bi-arrow-through-heart" id="heart-icon"></i>
                                    <i class="bi bi-arrow-through-heart-fill" id="heart-icon-fill"></i>

                                    <div class="notice-content" name="postContent"></div>
                                </div>

                                <div class="comment-section">
                                    <div class="comment-input-container">
                                        <div class="comment-input">
                                            <textarea id="commentText" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button class="btn btn-sm btn-primary me-md-2" type="button" id="submitCommentBtn">ëŒ“ê¸€ ì‘ì„±</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        content.innerHTML = boardPostPage;

                        $.ajax({
                            url: `/sep/${companyNo}/community/detailPost`,
                            data: {postNo: postNo},
                            success: function(data){

                                // ì‘ì„±ì
                                document.querySelector('[name="postEmpNm"]').textContent = 'ì‘ì„±ì : ' + data.postDetail.employee.empNm;

                                // ì œëª©, ë‚´ìš©, ì‘ì„±ì¼, ì¡°íšŒìˆ˜, ì¢‹ì•„ìš”ìˆ˜
                                data.postDetail.board.forEach(function(boardItem){
                                    // ê²Œì‹œíŒ ì œëª©
                                    document.querySelector('[name="boardNm"]').textContent = boardItem.boardNm

                                    boardItem.post.forEach(function(postItem){
                                        document.querySelector('[name="postTitle"]').textContent = postItem.postTitle
                                        document.querySelector('[name="postViewCount"]').textContent = postItem.postViewCount
                                        document.querySelector('[name="postLikeCount"]').textContent = postItem.postLikeCount
                                        document.querySelector('[name="postContent"]').textContent = postItem.postContent
                                    });
                                });

                                document.querySelector('[name="postTitle"]').textContent = data.title
                            }
                        })

                        // ì¢‹ì•„ìš” ì•„ì´ì½˜ ìƒ‰ ë¶€ë“œëŸ½ê²Œ ì „í™˜
						let isLiked = false;
						$.ajax({
							url: `/sep/${companyNo}/community/postLiktStatus`,
							data: { postNo: postNo, memberNo: memberNo },
							success: function(data){
								isLiked = data.isLiked;

						        if (isLiked) {
						            document.querySelector('#heart-icon').style.opacity = 0;
						            document.querySelector('#heart-icon-fill').style.opacity = 1;
						        } else {
						            document.querySelector('#heart-icon').style.opacity = 1;
						            document.querySelector('#heart-icon-fill').style.opacity = 0;
						        }
						    }
						});
                        document.querySelector('#heart-icon-fill').addEventListener('click', function(){
							const url = `/sep/${companyNo}/community/postLike`;
							const method = 'POST';

							// ì¢‹ì•„ìš” ì·¨ì†Œ
							if(isLiked){
								document.querySelector('#heart-icon').style.opacity = 1;
								document.querySelector('#heart-icon-fill').style.opacity = 0;
								isLiked = false;
								$.ajax({
									url: url,
									method: method,
									data: { postNo: postNo, memberNo: memberNo, isLiked: false },
									success: function(data){
										document.querySelector('[name="postLikeCount"]').textContent = data.likeCount;

									}
								})
							// ì¢‹ì•„ìš” ë“±ë¡
							}else{
								document.querySelector('#heart-icon').style.opacity = 0;
								document.querySelector('#heart-icon-fill').style.opacity = 1;
								isLiked = true;
								$.ajax({
									url: url,
									method: method,
									data: { postNo: postNo, memberNo: memberNo, isLiked: true },
									success: function(data){
										document.querySelector('[name="postLikeCount"]').textContent = data.likeCount;

									}
								})
							}
						});
                    }
                }
            }
        });
        // ê²Œì‹œíŒ ë§Œë“¤ê¸°
        const addBoard = document.querySelector('#addBoard');
        addBoard.addEventListener('click', function() {
            boardInsert(); // ê²Œì‹œíŒ ë§Œë“¤ê¸° ì´ë²¤íŠ¸ í˜¸ì¶œ
        });
    }

	// ì¢Œì¸¡ í†±ë‹ˆë°”í€´ ëª¨ì–‘ í´ë¦­ ì‹œ ì˜¤ë¥¸ìª½ í™”ë©´ ë™ì ìœ¼ë¡œ ë³€ê²½
	const roomManagement = document.querySelectorAll('.roomManagement');

	roomManagement.forEach(function(icon) {
		icon.addEventListener('click', function(e) {
			e.stopPropagation();
			const communityNo = icon.getAttribute('data-community-no');
			currentCommunityNo = communityNo;

			card.innerHTML = '';

			const roomManagementData = `
				<div class="mb-3" id="mainCard">
					<div class="card-body">
						<ul class="nav nav-tabs nav-tabs-bordered" id="community-room-tabs">
							<li class="nav-item">
								<button class="nav-link active" id="community-roomUpdate-tab" data-bs-target="#community-roomUpdate">
									ë°© í¸ì§‘
								</button>
							</li>
							<li class="nav-item">
								<button class="nav-link" id="community-member-tab" data-bs-target="#community-member">
									íšŒì› ê´€ë¦¬
								</button>
							</li>
							<li class="nav-item">
								<button class="nav-link" id="community-roomDelete-tab" data-bs-target="#community-roomDelete">
									ë°© íì‡„
								</button>
							</li>
						</ul>
					</div>
				</div>

				<div id="community-roomUpdate" class="tab-pane fade show active">
					<div class="card shadow-sm border-0 p-4" style="background-color: #f9f9fb;">
						<div class="mb-4">
							<label for="communityName" class="form-label fw-bold text-secondary">ì»¤ë®¤ë‹ˆí‹°ëª…</label>
							<div class="form-control bg-white" readonly style="min-height: 40px;">
								<span name="communityNm"></span>
							</div>
						</div>

						<div class="mb-4">
							<label for="communityDescription" class="form-label fw-bold text-secondary">ì»¤ë®¤ë‹ˆí‹° ì„¤ëª…</label>
							<textarea class="form-control" name="communityContent" rows="4" placeholder="ì»¤ë®¤ë‹ˆí‹° ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
						</div>

						<div class="mb-2">
							<label for="master" class="form-label fw-bold text-secondary">ë§ˆìŠ¤í„°ëª…</label>
							<div class="d-flex align-items-center justify-content-between bg-white form-control" style="min-height: 40px;">
								<span name="roomMasterName" class="text-dark"></span>
								<div class="oval-icon-container ms-2">
									<i class="fas fa-plus fs-6" style="cursor: pointer; color: #0d6efd;"></i>
								</div>
							</div>
						</div>
					</div>

					<div class="d-grid gap-2 col-1 mx-auto">
					  <button class="btn btn-primary" type="button" id="roomUpdateBtn">ì €ì¥í•˜ê¸°</button>
					</div>
				</div>

					<div id="community-member" class="tab-pane fade">
						<div class="table-responsive">
							<table id="add-row" class="table table-hover display">
								<thead>
									<tr>
										<th><input type="checkbox" id="select-all" /></th>
										<th>No</th>
										<th>ì•„ì´ë””</th>
										<th>ì´ë¦„</th>
										<th>ê°€ì…ì¼</th>
										<th>ìƒíƒœ</th>
										<th>ìƒíƒœì²˜ë¦¬</th>
									</tr>
								</thead>
								<tbody id="tableBody"></tbody>
							</table>
						</div>
						<div class="d-grid gap-2 col-1 mx-auto">
						  <button class="btn btn-primary" type="button" id="joinStatusBtn">ì €ì¥í•˜ê¸°</button>
						  <input type="text" name="userStatus">
						  <input type="text" name="communityNo">
						  <input type="text" name="empId">
						  <input type="text" name="memberRole">
						  <input type="text" name="memberActivityStatus">
						  <input type="text" name="requestNo">
						  <input type="text" name="memberNo">
						</div>
					</div>

					<div id="community-roomDelete" class="tab-pane fade">
						<div class="alert alert-warning mt-3" role="alert" style="line-height: 1.6;">
							<p class="mb-2">
								ì»¤ë®¤ë‹ˆí‹°ë¥¼ íì‡„í•˜ì‹œë©´, í˜„ì¬ ì»¤ë®¤ë‹ˆí‹° ë‚´ì— ìˆëŠ” ëª¨ë“  ìë£Œë“¤ì´ ì‚­ì œë©ë‹ˆë‹¤.
							</p>
							<p class="fw-bold text-danger mb-0">
								ìë£Œê°€ ì‚­ì œëœ ì´í›„ì—ëŠ” ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
							</p>
						</div>
						<div class="text-end mt-3">
							<button class="btn btn-danger" id="shutDown" data-bs-toggle="modal" data-bs-target="#closureModal">
								íì‡„í•˜ê¸°
							</button>
						</div>
					</div>
				</div>
			`;
			content.innerHTML = roomManagementData;
			bindCustomTabEvents(); // í†±ë‹ˆë°”í€´ íƒ­ ì´ë™ ì´ë²¤íŠ¸ í˜¸ì¶œ
			history.pushState({ page: "roomManagement" }, "Room Management", "#roomManagement");


			const tableBody = document.querySelector('#tableBody');

			$.ajax({
				url: `/sep/${companyNo}/community/roomManagement`,
				data: { communityNo: communityNo },
				success: function(data) {
					// ë°© í¸ì§‘ íƒ­
					data.roomManagement.forEach(function(item) {
						document.querySelector('[name="communityNm"]').textContent = item.communityNm;
						document.querySelector('[name="communityContent"]').textContent = item.communityContent;
						document.querySelector('[name="roomMasterName"]').textContent = item.employee.empNm;
					});

					// íšŒì›ê´€ë¦¬ íƒ­
					let cnt = 0;
					data.roomManagement.forEach(function(item) {

						item.joinStatus.forEach(function(status) {
							const matchingMember = item.communityMember.find(m => m.employee.empId === status.empId);
							const memberRole = matchingMember ? matchingMember.memberRole : null;
							const memberNo = matchingMember ? matchingMember.memberNo : null;

							console.log("memberNo", memberNo);
							const tableContetn = `
								<tr class="post-row">
									<td><input type="checkbox"></td>
									<td>${cnt += 1}</td>
									<td>${status.empId}</td>
									<td>${status.employee.empNm}</td>
									<td>${status.requestDate}</td>
									<td>${status.userStatus}</td>
									<td>
										${
											memberRole === 'ë°© ì£¼ì¸'
												? ''
												: status.userStatus === 'ìŠ¹ì¸'
													? `<button class="btn btn-sm btn-danger expel-btn deleteStatusBtn"
														data-member-no="${memberNo}"
														data-request-no="${status.requestNo}">ê°•í‡´</button>`
													: status.userStatus === 'ëŒ€ê¸°'
														? `<select class="form-select form-select-sm status-select" data-emp-id="${status.empId}" style="width: 70px;">
																<option value disabled hidden selected>âœ”</option>
																<option value="ìŠ¹ì¸">ìŠ¹ì¸</option>
																<option value="ê±°ì ˆ">ê±°ì ˆ</option>
														   </select>`
														: ''
										}
									</td>
								</tr>
							`;
							tableBody.innerHTML += tableContetn;

							});

					});
					// ì„œë²„ ì „ì†¡ì„ ìœ„í•œ input ê°’ ì…‹íŒ…
					document.addEventListener('change',function(e){
						if(e.target.classList.contains('status-select')){
							const selectedValue = e.target.value;
							const empId = e.target.getAttribute('data-emp-id');

							userStatusInput = document.querySelector('[name="userStatus"]');
							communityNoInput = document.querySelector('[name="communityNo"]');
							empIdInput = document.querySelector('[name="empId"]');
							memberRoleInput = document.querySelector('[name="memberRole"]');
							memberActivityStatusInput = document.querySelector('[name="memberActivityStatus"]');



							// input ê°’ ì…‹íŒ…
							userStatusInput.value = selectedValue;
							communityNoInput.value = currentCommunityNo;
							empIdInput.value = empId;


							if(selectedValue === "ìŠ¹ì¸"){
								memberRoleInput.value = "ë©¤ë²„";
								memberActivityStatusInput.value = "í™œë™ì¤‘";

							}else if(selectedValue === "ê±°ì ˆ"){
								memberRoleInput.value = "";
								memberActivityStatusInput.value = "";
							}else{
								userStatusInput.value = "";
								communityNoInput.value = "";
								empIdInput.value = "";
								memberRoleInput.value = "";
								memberActivityStatusInput.value = "";
							}

						}
					});
				}
			});

			// ë°© ê´€ë¦¬ ì €ì¥í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
			const roomUpdateBtn = document.querySelector('#roomUpdateBtn');

			roomUpdateBtn.addEventListener('click', function(){
				const communityContent = document.querySelector('[name="communityContent"]');
				const communityNo = currentCommunityNo

				console.log("communityContent", communityContent);
				console.log("communityNo", communityNo);

				$.ajax({
					url: `/sep/${companyNo}/community/roomDataUpdate`,
					type: 'POST',
					data: {
						communityContent: communityContent.value,
						communityNo: communityNo
					},
					success: function(){
						Swal.fire({
						  title: "ì»¤ë®¤ë‹ˆí‹°ë°© í¸ì§‘ ì„±ê³µ",
						  icon: "success",
						  draggable: true
						});
					}
				});

			});

			// íšŒì›ê´€ë¦¬ ì €ì¥í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
			const joinStatusBtn = document.querySelector('#joinStatusBtn');

			// ê°€ì… ìŠ¹ì¸ ë˜ëŠ” ê±°ì ˆ ì²˜ë¦¬
			joinStatusBtn.addEventListener('click', function(){
				console.log("ë‚˜ í´ë¦­í•¨");

				$.ajax({
					url: `/sep/${companyNo}/community/joinStatus`,
					type: 'POST',
					data: {
						userStatus: userStatusInput.value,
						communityNo: communityNoInput.value,
						empId: empIdInput.value,
						memberRole: memberRoleInput.value,
						memberActivityStatus: memberActivityStatusInput.value
					},

					success: function (response) {
					    if (response.result === "success") {
					        const updated = response.updateStatus;

					        const row = [...document.querySelectorAll('.post-row')]
					            .find(tr => tr.children[2].textContent === updated.empId);

					        if (row) {
					            row.children[5].textContent = updated.userStatus;

					            const statusCell = row.children[6];
					            if (updated.userStatus === 'ìŠ¹ì¸') {
					                statusCell.innerHTML = `<button class="btn btn-sm btn-danger expel-btn" data-emp-id="${updated.empId}">ê°•í‡´</button>`;
					            } else if (updated.userStatus === 'ê±°ì ˆ') {
					                row.remove();
					            }
					        }

							Swal.fire({
							  title: "ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.",
							  icon: "success",
							  draggable: true
							});
					    }
					}
				});
			});

			// ê°•í‡´ì²˜ë¦¬
			document.addEventListener('click', function(e){
				if(e.target.classList.contains('deleteStatusBtn')){
					const memberNo = e.target.getAttribute('data-member-no');
					const requestNo = e.target.getAttribute('data-request-no');

					requestNoInput = document.querySelector('[name="requestNo"]');
					memberNoInput = document.querySelector('[name="memberNo"]');
					requestNoInput.value = requestNo;
					memberNoInput.value = memberNo;

					const row = e.target.closest('tr');
					$.ajax({
						url: `/sep/${companyNo}/community/deleteMember`,
						type: 'POST',
						data: {
							requestNo : requestNoInput.value,
							memberNo : memberNoInput.value
						},
						success: function(response){
							Swal.fire({
							  title: "ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.",
							  icon: "success",
							  draggable: true
							});

							if (row) row.remove();
						}
					});
				}
			});

			// íí™°í•˜ê¸° ì´ë²¤íŠ¸
			document.querySelector('#confirmClosureBtn').addEventListener('click', function(){
				const closureReason = document.querySelector('#closure-reason').value;
				const communityNo = this.getAttribute('data-community-no');

				if(!closureReason.trim()){
					Swal.fire({
					  icon: "error",
					  title: "íì‡„ ì²˜ë¦¬ ì‹¤íŒ¨",
					  text: "íì‡ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”",
					});
					return;
				}

				$.ajax({
					url: `/sep/${companyNo}/community/shutDown`,
					type: 'POST',
					data: {
						closureReason: closureReason,
						communityNo: communityNo

					},
					success: function(response){
						Swal.fire({
						  title: "ì •ìƒì²˜ë¦¬ì™„ë£Œ",
						  icon: "success",
						  draggable: true
						});
						location.reload();
					}
				});
			});
		});

	});


    // ì¢Œì¸¡ ê°€ì…ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ í´ë¦­ ì‹œ ì˜¤ë¥¸ìª½ ë‚´ìš© ë™ì ìœ¼ë¡œ ë³€ê²½ (AJAXë¥¼ í†µí•´ ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
    communityItems.forEach(function(item) {
        item.addEventListener('click', function() {
            const communityNo = this.getAttribute('data-community-no');
            loadCommunityBoard(communityNo); // ì•„ë˜ ì´ë²¤íŠ¸ í˜¸ì¶œ


        });
    });

    function loadCommunityBoard(communityNo, skipPush) {
		card.innerHTML = '';

        let cnt = 0;
        const tableHeader = `

            <div class="table-responsive">
                <table id="add-row" class="table table-hover display">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th>
                            <th>ê¸€ë²ˆí˜¸</th>
                            <th>ê²Œì‹œíŒëª…</th>
                            <th>ì œëª©</th>
                            <th>ì‘ì„±ì</th>
                            <th>ì‘ì„±ì¼</th>
                            <th>ì¡°íšŒìˆ˜</th>
                            <th>ì¢‹ì•„ìš”</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        `;
        content.innerHTML = tableHeader;

		if (!skipPush) {
		    history.pushState({ page: "communityBoard", communityNo: communityNo }, "Community Board", `#communityBoard/${communityNo}`);
		}

        const tableBody = document.querySelector('#tableBody');
        // ìš°ì¸¡ì— ê²Œì‹œê¸€ ëª©ë¡ ì¶œë ¥
        $.ajax({
            url: `/sep/${companyNo}/community/getPost`,
            data: { communityNo: communityNo },
            success: function(data) {

                data.board.forEach(function(boards) {
                    boards.board.forEach(function(boardItem) {
                        if (boardItem.post.length === 0) {
                            noPosts = true;
                        } else {
                            noPosts = false;
                            boardItem.post.forEach(function(postItem) {
                                const communityContent = `
                                    <tr class="post-row" data-post-id="${postItem.postNo}">
										<input type="hidden" data-member-no="${postItem.memberNo}" value="${postItem.memberNo}">
                                        <td><input type="checkbox"></td>
                                        <td>${cnt += 1}</td>
                                        <td>${boardItem.boardNm}</td>
                                        <td>${postItem.postTitle}</td>
                                        <td>${boards.employee.empNm}</td>
                                        <td>${postItem.postCreatedAt}</td>
                                        <td>${postItem.postViewCount}</td>
                                        <td>${postItem.postLikeCount}</td>
                                    </tr>
                                `;
                                tableBody.innerHTML += communityContent;
                            });
                        }
                    });
                });
                // ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ì„ ê²½ìš° ì¶œë ¥
                if (noPosts) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            }
        });

        tableBody.addEventListener('click', function(e){
            card.innerHTML = '';
            const tr = e.target.closest('tr.post-row');
            const postNo = tr.getAttribute('data-post-id');

			const inputElement = tr.querySelector('input[data-member-no]');
			const memberNo = inputElement.getAttribute('data-member-no');
            postDetail(postNo, memberNo); // ì•„ë˜ í•¨ìˆ˜ í˜¸ì¶œ
        });

        function postDetail(postNo, memberNo, skipPush){
			currentPostNo = postNo;   // â† ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
			currentMemberNo = memberNo;
            const detailPage = `
                <div class="notice-container">
                    <div class="button-group">
                        <button type="button" class="btn btn-sm btn-info">Update</button>
                    </div>

                    <div class="notice-info">
                        <strong name="boardNm"></strong>
                    </div>

                    <div class="notice-title" name="postTitle"></div>

					<div class="notice-info">
					    <span name="postEmpNm"></span>

						<div class="icon-view-count">
						    <i class="fas fa-thumbs-up"></i>
						    <span name="postLikeCount" id="postLikeCount"></span>

						    <i class="fas fa-eye"></i>
						    <span name="postViewCount"></span>
						</div>
					</div>

                    <div class="notice-container">
                        <i class="bi bi-arrow-through-heart" id="heart-icon"></i>
                        <i class="bi bi-arrow-through-heart-fill" id="heart-icon-fill"></i>

                        <div class="notice-content" name="postContent"></div>
                    </div>

					<div class="comment-section mt-4">

					    <div id="commentList" class="mb-3">
					        <p class="text-muted" id="noCommentsText">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
					    </div>

					    <div class="d-flex justify-content-between align-items-center mb-2">
					        <button class="btn btn-outline-secondary btn-sm" id="toggleCommentInput">
					            <i class="bi bi-chat-dots"></i> ëŒ“ê¸€ ì‘ì„±
					        </button>
					    </div>

					    <div id="commentInputContainer" class="d-none">
					        <div class="mb-2">
					            <textarea id="commentText" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
					        </div>
					        <div class="d-flex justify-content-end">
					            <button class="btn btn-primary btn-sm" id="submitCommentBtn">
					                <i class="bi bi-send"></i> ëŒ“ê¸€ ì‘ì„±
					            </button>
					        </div>
					    </div>
					</div>
                </div>
            `;

            content.innerHTML = detailPage;

			if (!skipPush) {
			    history.pushState({ page: "postDetail", postNo: postNo, memberNo: memberNo }, "Post Detail", `#postDetail/${postNo}`);
			}

            $.ajax({
                url: `/sep/${companyNo}/community/detailPost`,
                data: {postNo: postNo},
                success: function(data){
                    // ì‘ì„±ì
                    document.querySelector('[name="postEmpNm"]').textContent = 'ì‘ì„±ì : ' + data.postDetail.employee.empNm;

                    // ì œëª©, ë‚´ìš©, ì‘ì„±ì¼, ì¡°íšŒìˆ˜, ì¢‹ì•„ìš”ìˆ˜
                    data.postDetail.board.forEach(function(boardItem){
                        // ê²Œì‹œíŒ ì œëª©
                        document.querySelector('[name="boardNm"]').textContent = boardItem.boardNm

                        boardItem.post.forEach(function(postItem){
							document.querySelector('[name="postTitle"]').textContent = postItem.postTitle
							document.querySelector('[name="postViewCount"]').textContent = postItem.postViewCount
							document.querySelector('[name="postLikeCount"]').textContent = postItem.postLikeCount
							document.querySelector('[name="postContent"]').textContent = postItem.postContent
                        });
                    });

                    document.querySelector('[name="postTitle"]').textContent = data.title
					loadComments(postNo); // â† ì—¬ê¸°ì— ì¶”ê°€

                }
            })

			// ì¢‹ì•„ìš” ì•„ì´ì½˜ ìƒ‰ ë¶€ë“œëŸ½ê²Œ ì „í™˜
			let isLiked = false;
			$.ajax({
				url: `/sep/${companyNo}/community/postLiktStatus`,
				data: { postNo: postNo, memberNo: memberNo },
				success: function(data){
					isLiked = data.isLiked;

			        if (isLiked) {
			            document.querySelector('#heart-icon').style.opacity = 0;
			            document.querySelector('#heart-icon-fill').style.opacity = 1;
			        } else {
			            document.querySelector('#heart-icon').style.opacity = 1;
			            document.querySelector('#heart-icon-fill').style.opacity = 0;
			        }

			    }
			});
			document.querySelector('#heart-icon-fill').addEventListener('click', function(){
				const url = `/sep/${companyNo}/community/postLike`;
				const method = 'POST';

				// ì¢‹ì•„ìš” ì·¨ì†Œ
				if(isLiked){
					document.querySelector('#heart-icon').style.opacity = 1;
					document.querySelector('#heart-icon-fill').style.opacity = 0;
					isLiked = false;
					$.ajax({
						url: url,
						method: method,
						data: { postNo: postNo, memberNo: memberNo, isLiked: false },
						success: function(data){
							document.querySelector('[name="postLikeCount"]').textContent = data.likeCount;

						}
					})
				// ì¢‹ì•„ìš” ë“±ë¡
				}else{
					document.querySelector('#heart-icon').style.opacity = 0;
					document.querySelector('#heart-icon-fill').style.opacity = 1;
					isLiked = true;
					$.ajax({
						url: url,
						method: method,
						data: { postNo: postNo, memberNo: memberNo, isLiked: true },
						success: function(data){
							document.querySelector('[name="postLikeCount"]').textContent = data.likeCount;

						}
					})
				}

			});
        }
    }

	// ëŒ“ê¸€ ì¡°íšŒ
	function loadComments(postNo) {
	    $.ajax({
	        url: `/sep/${companyNo}/community/selectComment`,
	        method: "GET",
	        data: { postNo },
	        success: function(response) {
	            const container = document.getElementById("commentList");
	            container.innerHTML = ""; // ê¸°ì¡´ ëŒ“ê¸€ ë¹„ìš°ê¸°

	            const comments = response.comments || []; // í˜¹ì‹œ null ë°©ì§€

	            if (comments.length === 0) {
	                container.innerHTML = `<p class="text-muted">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
	                return;
	            }

	            comments.forEach(comment => {
	                const writerName = comment.communityMember?.employee?.empNm || "ìµëª…";
	                const writeDate = comment.replyCreateDate || "";
	                const content = comment.replyContent || "";

	                const commentHTML = `
	                    <div class="mb-2 border p-2 rounded bg-light">
	                        <div class="fw-bold">${writerName}</div>
	                        <div class="small text-muted">${writeDate}</div>
	                        <div>${content}</div>
	                    </div>
	                `;
	                container.insertAdjacentHTML("beforeend", commentHTML);
	            });
	        },
	        error: function() {
	            alert("ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	        }
	    });
	}
	// ëŒ“ê¸€ ë“±ë¡
	document.addEventListener("click", function (e) {
		console.log("datafdsafsdfdsf", currentPostNo);
		console.log("datafdsafsdfdsf", currentMemberNo);

	    // ëŒ“ê¸€ ì‘ì„± ì•„ì´ì½˜ í´ë¦­ ì‹œ
	    if (e.target.closest("#toggleCommentInput")) {
	        const inputBox = document.getElementById("commentInputContainer");
	        inputBox.classList.toggle("d-none");
	    }

	    // ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
	    if (e.target.closest("#submitCommentBtn")) {
	        const text = document.getElementById("commentText").value.trim();
	        if (!text) {
	            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
	            return;
	        }

	        // postNo, memberNoëŠ” ì™¸ë¶€ ìŠ¤ì½”í”„ì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ í•´ì•¼ í•¨ (ì˜ˆ: ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥í•˜ê±°ë‚˜ dataset ë“±ìœ¼ë¡œ ë„˜ê¸°ê¸°)
	        // ì—¬ê¸°ì„  ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥í–ˆë‹¤ê³  ê°€ì •í• ê²Œ
	        $.ajax({
	            url: `/sep/${companyNo}/community/insertComment`,
	            method: "POST",
	            data: {
	                postNo: currentPostNo, // <- ì „ì—­ë³€ìˆ˜ë¡œ ì €ì¥í•´ë†¨ë‹¤ê³  ê°€ì •
	                memberNo: currentMemberNo,
	                replyContent: text
	            },
	            success: function(response) {
	                if (response.result === "success") {
	                    alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
	                    document.getElementById("commentText").value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
	                    document.getElementById("commentInputContainer").classList.add("d-none");

	                    // ğŸ‘‰ ì—¬ê¸°ì„œ ìƒˆë¡œ ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ í˜¸ì¶œ ê°€ëŠ¥
						loadComments(currentPostNo);
	                }
	            },
	            error: function() {
	                alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	            }
	        });
	    }
	});

    // ë°© ë§Œë“¤ê¸°
    const roomInsert = document.querySelector('#roomInsert');
    roomInsert.addEventListener('click', function() {
        roomInsertForm(); // ì•„ë˜ ì½”ë“œ í˜¸ì¶œ
    });

    function roomInsertForm() {
		card.innerHTML = '';
        const roomInsertForm = `
            <div class="community-create-form">
                <h3>ì»¤ë®¤ë‹ˆí‹° ê°œì„¤</h3>
                <form id="formData" action="/sep/${companyNo}/community/insertRoom" method="post">
                    <div class="form-group">
                        <label for="communityName">ì»¤ë®¤ë‹ˆí‹°ëª…</label>
                        <input type="text" class="form-control" name="communityNm" placeholder="ì»¤ë®¤ë‹ˆí‹°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label for="communityDescription">ì»¤ë®¤ë‹ˆí‹° ì„¤ëª…</label>
                        <textarea class="form-control" name="communityContent" placeholder="ì»¤ë®¤ë‹ˆí‹°ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4"></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-sm btn-primary" id="formButton">ì»¤ë®¤ë‹ˆí‹° ë§Œë“¤ê¸°</button>
                    </div>
                </form>
            </div>
        `;
        content.innerHTML = roomInsertForm;
		history.pushState({ page: "roomInsert" }, "Room Insert", "#roomInsert");

    }

    // ê²Œì‹œíŒ ë§Œë“¤ê¸° form
    function boardInsert() {
		card.innerHTML = '';

        const boardInsertForm = `
            <div class="community-create-form">
                <h3>ê²Œì‹œíŒ ë§Œë“¤ê¸°</h3>
                <div class="form-group">
                    <label for="boardName">ê²Œì‹œíŒëª…</label>
                    <input type="text" class="form-control" name="boardNm" id="boardNm" placeholder="ê²Œì‹œíŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="boardDescription">ê²Œì‹œíŒ ì„¤ëª…</label>
                    <textarea class="form-control" name="boardDescription" id="boardContent" placeholder="ê²Œì‹œíŒì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4"></textarea>
                </div>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-sm btn-primary" id="createBoardButton">ê²Œì‹œíŒ ë§Œë“¤ê¸°</button>
                </div>
            </div>
        `;
        content.innerHTML = boardInsertForm;

        const createBoardButton = document.querySelector('#createBoardButton');
        createBoardButton.addEventListener('click', function() {
            const boardNm = document.querySelector('#boardNm').value;
            const boardContent = document.querySelector('#boardContent').value;
            const communityNo = currentCommunityNo;

            $.ajax({
                url: `/sep/${companyNo}/community/insertBoard`,
                type: 'POST',
                data: {
                    communityNo: communityNo,
                    boardContent: boardContent,
                    boardNm: boardNm
                },
                success: function() {
					Swal.fire({
					  title: "ê²Œì‹œíŒ ìƒì„± ì™„ë£Œ",
					  icon: "success",
					  draggable: true
					});
                    window.location.href = `/sep/${companyNo}/community`;
                }
            });
        });
    }

	// ì»¤ë®¤ë‹ˆí‹° ê°€ì…í•˜ê¸°
	const joinRoomBtn = document.querySelectorAll('.joinRoom');
	joinRoomBtn.forEach(function(icon){
		icon.addEventListener('click', function(){
			const communityNo = this.getAttribute('data-community-no');
			const buttonElement = this;
			console.log("zz", communityNo);
			console.log("ê°€ì…í•˜ê¸°");

			$.ajax({
				url: `/sep/${companyNo}/community/joinStatusInsert`,
				type: 'POST',
				data: { communityNo: communityNo },
				success: function(){
					Swal.fire({
					  title: "ê°€ì…ìš”ì²­ ì™„ë£Œ",
					  icon: "success",
					  draggable: true
					});
					const badge = document.createElement('span');
					badge.className = "badge bg-warning text-dark";
					badge.innerText = "ìŠ¹ì¸ ëŒ€ê¸°ì¤‘";

					// ë²„íŠ¼ì„ ë±ƒì§€ë¡œ êµì²´
					buttonElement.parentNode.replaceChild(badge, buttonElement);
				}
			});
		})
	});


	window.addEventListener("popstate", function(event) {
	    const state = event.state;
	    console.log("popstate ë°œìƒ", state);

	    if (!state || !state.page) {
	        console.warn("popstate - state.page ì—†ìŒ", state);
			location.reload(); // âœ… ì—¬ê¸°ì„œ ê·¸ëƒ¥ ìƒˆë¡œê³ ì¹¨!

	        return;
	    }

	    switch (state.page) {
	        case "roomInsert":
	        case "roomManagement":
	        case "communityDetails":
				location.reload(); // ë˜ëŠ” ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì‹ë„ ê°€ëŠ¥
	            break;

	        case "communityBoard":
	            loadCommunityBoard(state.communityNo, true);
	            break;

	        case "postDetail":
	            postDetail(state.postNo, state.memberNo, true);
	            break;

	        case "boardPostList":
	            boardNumberPostList(state.boardNo, true);
	            break;

	        case "boardInsert":
	            boardInsert();
	            break;

	        default:
	            console.warn("ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœ:", state);
	            break;
	    }
	});

	// ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ì„ í´ë¦­í–ˆì„ ë•Œ ìƒíƒœ ê¸°ë¡ (pushState ì‚¬ìš©)
	communityItems.forEach(function(item) {
	    item.addEventListener('click', function() {
	        const communityNo = this.getAttribute('data-community-no');

	        // ìƒíƒœë¥¼ íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ (ë’¤ë¡œê°€ê¸°ë¥¼ í•  ë•Œ ì´ì „ ìƒíƒœë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆë„ë¡ pushState ì‚¬ìš©)
	        history.pushState({ page: "communityBoard", communityNo: communityNo }, "Community Board", `#communityBoard/${communityNo}`);

	        // ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ í™”ë©´ ë¡œë“œ
	        loadCommunityBoard(communityNo);
	    });
	});
});

